<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="rrapply">
<title>Recursive apply for calls and expressions • rrapply</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Recursive apply for calls and expressions">
<meta property="og:description" content="rrapply">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">rrapply</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.5</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/1-when-to-use-rrapply.html">Efficient list recursion with rrapply</a>
    <a class="dropdown-item" href="../articles/2-efficient-melting-unnesting.html">Efficient list melting and unnesting with rrapply</a>
    <a class="dropdown-item" href="../articles/3-calls-and-expressions.html">Recursive apply for calls and expressions</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/JorisChau/rrapply/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Recursive apply for calls and expressions</h1>
                        <h4 data-toc-skip class="author">Joris Chau</h4>
            
            <h4 data-toc-skip class="date">Latest date: 2022-07-23</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/JorisChau/rrapply/blob/HEAD/vignettes/articles/3-calls-and-expressions.Rmd" class="external-link"><code>vignettes/articles/3-calls-and-expressions.Rmd</code></a></small>
      <div class="d-none name"><code>3-calls-and-expressions.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="expressions">Expressions<a class="anchor" aria-label="anchor" href="#expressions"></a>
</h2>
<p>Unevaluated R code is always parsed or captured as a set of
<em>expressions</em>, a collective term used to refer to any of the
following object types: scalar constants e.g. <code>TRUE</code> or
<code>1</code>, symbols e.g. <code>quote(x)</code>, call objects
e.g. <code>quote(x &lt;- 1)</code>, expression vectors
e.g. <code>expression(a &lt;- 1, 2 * b)</code> or pairlists
e.g. <code>formals(seq.default)</code>. Call objects and expression
vectors are hierarchically structured objects (also called <em>abstract
syntax trees</em>) that can be decomposed into symbols and scalar
constants as atomic building blocks. See also the chapter <a href="https://adv-r.hadley.nz/expressions.html" class="external-link uri">https://adv-r.hadley.nz/expressions.html</a> for a general
introduction to expressions and abstract syntax trees.</p>
<p>Call objects and expression vectors generally behave as nested lists,
e.g. subsetting a call object is achieved in the same way as subsetting
a nested list. To illustrate, we can retrieve the abstract syntax tree
of a call object by recursing through the object in the same way as for
a nested list:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## recurse through call as nested list</span></span>
<span><span class="va">ast</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">expr</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">expr</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/call.html" class="external-link">is.call</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">is.expression</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">ast</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> </span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">x</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## decompose call object</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="fu">ast</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">+</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 3</span></span>
<span><span class="co">#&gt;  $ : symbol &lt;-</span></span>
<span><span class="co">#&gt;  $ : symbol y</span></span>
<span><span class="co">#&gt;  $ :List of 3</span></span>
<span><span class="co">#&gt;   ..$ : symbol &lt;-</span></span>
<span><span class="co">#&gt;   ..$ : symbol x</span></span>
<span><span class="co">#&gt;   ..$ :List of 3</span></span>
<span><span class="co">#&gt;   .. ..$ : symbol +</span></span>
<span><span class="co">#&gt;   .. ..$ : num 1</span></span>
<span><span class="co">#&gt;   .. ..$ : logi TRUE</span></span></code></pre></div>
<p>Given this information, it is perhaps expected that base
<code><a href="https://rdrr.io/r/base/rapply.html" class="external-link">rapply()</a></code> also recurses through call objects and expression
vectors in the same way as for nested lists, but this is unfortunately
not the case. To be precise, <code><a href="https://rdrr.io/r/base/rapply.html" class="external-link">rapply()</a></code> does accept
expression vectors as inputs, but effectively treats the objects as flat
lists of call objects similar to <code><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply()</a></code>. Call objects are
not accepted at all by <code><a href="https://rdrr.io/r/base/rapply.html" class="external-link">rapply()</a></code> and return an error.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## rapply on an expression vector</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rapply.html" class="external-link">rapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span>, <span class="fu">f</span><span class="op">(</span><span class="fu">g</span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">pi</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, f <span class="op">=</span> <span class="va">identity</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; y &lt;- x &lt;- 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; f(g(2 * pi))</span></span>
<span></span>
<span><span class="co">## lapply on an expression vector</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span>, <span class="fu">f</span><span class="op">(</span><span class="fu">g</span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">pi</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, FUN <span class="op">=</span> <span class="va">identity</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; y &lt;- x &lt;- 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; f(g(2 * pi))</span></span>
<span></span>
<span><span class="co">## rapply on a call object (not ok!) </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rapply.html" class="external-link">rapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">)</span>, f <span class="op">=</span> <span class="va">identity</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in rapply(quote(y &lt;- x &lt;- 1), f = identity): 'object' must be a list or expression</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="expressions-and-rrapply">Expressions and <code>rrapply()</code><a class="anchor" aria-label="anchor" href="#expressions-and-rrapply"></a>
</h2>
<p>Starting from version 1.2.0, <code><a href="../reference/rrapply.html">rrapply()</a></code> also supports
recursion of call objects and expression vectors, which are treated as
nested lists based on their internal abstract syntax trees. As such, all
functionality described in
<code><a href="../articles/1-when-to-use-rrapply.html">vignette("1-when-to-use-rrapply")</a></code> extends directly to call
objects and expression vectors.</p>
<div class="section level3">
<h3 id="structuring-the-result">Structuring the result<a class="anchor" aria-label="anchor" href="#structuring-the-result"></a>
</h3>
<p>When applying <code><a href="../reference/rrapply.html">rrapply()</a></code> (or base <code><a href="https://rdrr.io/r/base/rapply.html" class="external-link">rapply()</a></code>)
to nested lists the difference between <code>how = "replace"</code> and
<code>how = "list"</code> is relatively minor. Both choices return a
nested list, but only <code>how = "list"</code> replaces elements not
subject to <code>f</code> by the argument <code>deflt</code>. For call
objects and expression objects, the difference is more important as
<code>how = "replace"</code> always maintains the type of the object
after application of <code><a href="../reference/rrapply.html">rrapply()</a></code>, whereas
<code>how = "list"</code> returns the object formatted as a nested
list.</p>
<p>With <code>how = "replace"</code>, we can for instance directly
update the abstract syntax tree of a call object:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jorischau.github.io/rrapply/" class="external-link">rrapply</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">call_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">+</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">call_obj</span><span class="op">)</span></span>
<span><span class="co">#&gt;  language y &lt;- x &lt;- 1 + TRUE</span></span>
<span></span>
<span><span class="co">## update call object</span></span>
<span><span class="fu"><a href="../reference/rrapply.html">rrapply</a></span><span class="op">(</span></span>
<span>  <span class="va">call_obj</span>, </span>
<span>  classes <span class="op">=</span> <span class="st">"logical"</span>, </span>
<span>  f <span class="op">=</span> <span class="va">as.numeric</span>, </span>
<span>  how <span class="op">=</span> <span class="st">"replace"</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;  language y &lt;- x &lt;- 1 + 1</span></span></code></pre></div>
<p>Using <code>how = "list"</code>, we can update the abstract syntax
tree and return it as a nested list:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## update and decompose call object</span></span>
<span><span class="fu"><a href="../reference/rrapply.html">rrapply</a></span><span class="op">(</span></span>
<span>  <span class="va">call_obj</span>, </span>
<span>  f <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">is.logical</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="va">x</span><span class="op">)</span>, </span>
<span>  how <span class="op">=</span> <span class="st">"list"</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 3</span></span>
<span><span class="co">#&gt;  $ : symbol &lt;-</span></span>
<span><span class="co">#&gt;  $ : symbol y</span></span>
<span><span class="co">#&gt;  $ :List of 3</span></span>
<span><span class="co">#&gt;   ..$ : symbol &lt;-</span></span>
<span><span class="co">#&gt;   ..$ : symbol x</span></span>
<span><span class="co">#&gt;   ..$ :List of 3</span></span>
<span><span class="co">#&gt;   .. ..$ : symbol +</span></span>
<span><span class="co">#&gt;   .. ..$ : num 1</span></span>
<span><span class="co">#&gt;   .. ..$ : num 1</span></span></code></pre></div>
<p><strong>Remark</strong>: in the second function call we did not use
<code>classes = "logical"</code> to avoid that all list elements that
are not of class <code>"logical"</code> are replaced by the
<code>deflt</code> argument (<code>NULL</code>).</p>
<p>The choices <code>how = "prune"</code>, <code>how = "flatten"</code>
and <code>how = "melt"</code> return the pruned abstract syntax tree as:
a nested list, a flattened vector or list and a melted data.frame
respectively. This is identical to application of <code><a href="../reference/rrapply.html">rrapply()</a></code>
to the abstract syntax tree formatted as a nested list. To illustrate,
let us return all names in the abstract syntax tree of an expression
vector that are not part of base R.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## example expression</span></span>
<span><span class="va">expr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span>, <span class="fu">f</span><span class="op">(</span><span class="fu">g</span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">pi</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## check if name is not in base environment</span></span>
<span><span class="va">is_new_name</span> <span class="op">&lt;-</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, envir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">baseenv</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## prune and decompose expression</span></span>
<span><span class="fu"><a href="../reference/rrapply.html">rrapply</a></span><span class="op">(</span></span>
<span>  <span class="va">expr</span>, </span>
<span>  classes <span class="op">=</span> <span class="st">"name"</span>, </span>
<span>  condition <span class="op">=</span> <span class="va">is_new_name</span>, </span>
<span>  how <span class="op">=</span> <span class="st">"prune"</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 2</span></span>
<span><span class="co">#&gt;  $ :List of 2</span></span>
<span><span class="co">#&gt;   ..$ : symbol y</span></span>
<span><span class="co">#&gt;   ..$ :List of 1</span></span>
<span><span class="co">#&gt;   .. ..$ : symbol x</span></span>
<span><span class="co">#&gt;  $ :List of 2</span></span>
<span><span class="co">#&gt;   ..$ : symbol f</span></span>
<span><span class="co">#&gt;   ..$ :List of 1</span></span>
<span><span class="co">#&gt;   .. ..$ : symbol g</span></span>
<span></span>
<span><span class="co">## prune and flatten expression</span></span>
<span><span class="fu"><a href="../reference/rrapply.html">rrapply</a></span><span class="op">(</span></span>
<span>  <span class="va">expr</span>, </span>
<span>  classes <span class="op">=</span> <span class="st">"name"</span>, </span>
<span>  condition <span class="op">=</span> <span class="va">is_new_name</span>, </span>
<span>  how <span class="op">=</span> <span class="st">"flatten"</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 4</span></span>
<span><span class="co">#&gt;  $ : symbol y</span></span>
<span><span class="co">#&gt;  $ : symbol x</span></span>
<span><span class="co">#&gt;  $ : symbol f</span></span>
<span><span class="co">#&gt;  $ : symbol g</span></span>
<span></span>
<span><span class="co">## prune and melt expression</span></span>
<span><span class="fu"><a href="../reference/rrapply.html">rrapply</a></span><span class="op">(</span></span>
<span>  <span class="va">expr</span>, </span>
<span>  classes <span class="op">=</span> <span class="st">"name"</span>, </span>
<span>  condition <span class="op">=</span> <span class="va">is_new_name</span>, </span>
<span>  how <span class="op">=</span> <span class="st">"melt"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;   L1 L2   L3 value</span></span>
<span><span class="co">#&gt; 1  1  2 &lt;NA&gt;     y</span></span>
<span><span class="co">#&gt; 2  1  3    2     x</span></span>
<span><span class="co">#&gt; 3  2  1 &lt;NA&gt;     f</span></span>
<span><span class="co">#&gt; 4  2  2    1     g</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="avoid-recursing-into-expressions">Avoid recursing into expressions<a class="anchor" aria-label="anchor" href="#avoid-recursing-into-expressions"></a>
</h3>
<p>If <code>classes = "ANY"</code> (the default), <code><a href="../reference/rrapply.html">rrapply()</a></code>
recurses into any list-like element, which for expression objects are:
call objects, expression vectors and pairlists. To avoid recursing into
list elements of a nested list, we can use
<code>classes = "list"</code>. Analogously, to avoid recursing into
list-like elements of the abstract syntax tree, we should use
<code>classes = "language"</code>, <code>classes = "expression"</code>,
<code>classes = "pairlist"</code> or any combination thereof. If the
<code>condition</code> and <code>classes</code> arguments are not
satisfied for a given list-like element, <code><a href="../reference/rrapply.html">rrapply()</a></code> will
recurse further into the object, apply the <code>f</code> function to
the nodes that satisfy <code>condition</code> and <code>classes</code>
and so on. Note that this behavior can only be triggered with the
<code>classes</code> argument and <em>not</em> through the use of
e.g. <code>condition = is.call</code>.</p>
<p>To illustrate, we extract all most deeply nested call objects of the
example expression above and return these as a flat list:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## extract all terminal call nodes of AST</span></span>
<span><span class="fu"><a href="../reference/rrapply.html">rrapply</a></span><span class="op">(</span></span>
<span>  <span class="va">expr</span>, </span>
<span>  classes <span class="op">=</span> <span class="st">"language"</span>, </span>
<span>  condition <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">is.call</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  how <span class="op">=</span> <span class="st">"flatten"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; x &lt;- 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; 2 * pi</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="additional-examples">Additional examples<a class="anchor" aria-label="anchor" href="#additional-examples"></a>
</h3>
<p>This section provides several worked out code examples using
<code><a href="../reference/rrapply.html">rrapply()</a></code> to recurse through the abstract syntax tree of a
call object, mainly inspired by the <code>codetools</code> package and
the chapter <a href="https://adv-r.hadley.nz/expressions.html#ast-funs" class="external-link uri">https://adv-r.hadley.nz/expressions.html#ast-funs</a>. Note
that all examples can also be rewritten using recursive function
definitions in base R, but the use of <code><a href="../reference/rrapply.html">rrapply()</a></code> makes the
code quite concise and straightforward to follow. The examples are
ordered in increasing degrees of code complexity.</p>
<div class="section level4">
<h4 id="example-1-replacing-t-and-f">Example 1: Replacing <code>T</code> and <code>F</code><a class="anchor" aria-label="anchor" href="#example-1-replacing-t-and-f"></a>
</h4>
<p>In <a href="https://adv-r.hadley.nz/expressions.html#ast-funs" class="external-link uri">https://adv-r.hadley.nz/expressions.html#ast-funs</a>, to
demonstrate recursion of the abstract syntax tree of an expression, a
recursive function <code>logical_abbr()</code> is defined to check for
the presence of the logical abbreviations <code>T</code> and
<code>F</code> in an expression object:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## recursive function to check for T or F</span></span>
<span><span class="va">logical_abbr</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.recursive.html" class="external-link">is.atomic</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="cn">FALSE</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/name.html" class="external-link">is.name</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="cn">F</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/call.html" class="external-link">is.call</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">is.pairlist</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu">logical_abbr</span><span class="op">(</span><span class="va">x</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="cn">FALSE</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Don't know how to handle type "</span>, <span class="fu"><a href="https://rdrr.io/r/base/typeof.html" class="external-link">typeof</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, </span>
<span>         call. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">call1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">call2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="fu">f</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## containing a logical abbreviation</span></span>
<span><span class="fu">logical_abbr</span><span class="op">(</span><span class="va">call1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">## not containing a logical abbreviation</span></span>
<span><span class="fu">logical_abbr</span><span class="op">(</span><span class="va">call2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<p>Let us revisit this example to not only find, but also replace any
logical abbreviations by their non-abbreviated counterparts. Using
<code><a href="../reference/rrapply.html">rrapply()</a></code>, we should set <code>how = "replace"</code> in
order to maintain the original object type after updating the abstract
syntax tree:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## expand logical abbreviation</span></span>
<span><span class="va">logical_abbr_expand</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="cn">TRUE</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="cn">F</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="cn">FALSE</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">x</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">call3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu">f</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">T</span>, <span class="cn">F</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="cn">T</span>, <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/rrapply.html">rrapply</a></span><span class="op">(</span><span class="va">call1</span>, f <span class="op">=</span> <span class="va">logical_abbr_expand</span>, how <span class="op">=</span> <span class="st">"replace"</span><span class="op">)</span></span>
<span><span class="co">#&gt; mean(x, na.rm = TRUE)</span></span>
<span><span class="fu"><a href="../reference/rrapply.html">rrapply</a></span><span class="op">(</span><span class="va">call3</span>, f <span class="op">=</span> <span class="va">logical_abbr_expand</span>, how <span class="op">=</span> <span class="st">"replace"</span><span class="op">)</span></span>
<span><span class="co">#&gt; expression(f(x = c(TRUE, FALSE)), any(TRUE, FALSE))</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="example-2-finding-local-variables">Example 2: Finding local variables<a class="anchor" aria-label="anchor" href="#example-2-finding-local-variables"></a>
</h4>
<p>A second demonstrating example of abstract syntax tree recursion in
<a href="https://adv-r.hadley.nz/expressions.html#ast-funs" class="external-link uri">https://adv-r.hadley.nz/expressions.html#ast-funs</a> deals
with finding all variables in an expression created by assignment. The
recursive function <code>find_assign()</code> finds all variables
created by assignment with <code>&lt;-</code> and returns them as a
character vector:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">find_assign</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.recursive.html" class="external-link">is.atomic</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/name.html" class="external-link">is.name</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/call.html" class="external-link">is.call</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">x</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="va">`&lt;-`</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/name.html" class="external-link">is.name</a></span><span class="op">(</span><span class="va">x</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">lhs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">x</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">lhs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">lhs</span>, <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">find_assign</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">is.pairlist</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">find_assign</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Don't know how to handle type "</span>, <span class="fu"><a href="https://rdrr.io/r/base/typeof.html" class="external-link">typeof</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, call. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">call4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">l</span><span class="op">$</span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"b"</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">find_assign</span><span class="op">(</span><span class="va">call4</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "l"</span></span></code></pre></div>
<p>Revisiting this example using <code><a href="../reference/rrapply.html">rrapply()</a></code>, we essentially
need to filter any name (i.e. symbol) that is the second element of a
call to <code>&lt;-</code>. Checking the position of the element in the
call can be done with the <code>.xpos</code> argument. To verify that
the first element of the call is an actual assignment, we can make use
of the <code>.xsiblings</code> argument. We slightly generalize the
<code>find_assign()</code> function to also return variables created by
<code>=</code>, <code>for</code>, <code>assign</code> or
<code>delayedAssign</code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## helper function to check if variable is created by assignment</span></span>
<span><span class="va">is_assign</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">.xpos</span>, <span class="va">.xsiblings</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">## element is second in call</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">.xpos</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">&amp;&amp;</span></span>
<span>    <span class="co">## first element in call is assignment</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">.xsiblings</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"&lt;-"</span>, <span class="st">"="</span>, <span class="st">"for"</span>, <span class="st">"assign"</span>, <span class="st">"delayedAssign"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="../reference/rrapply.html">rrapply</a></span><span class="op">(</span><span class="va">call4</span>, condition <span class="op">=</span> <span class="va">is_assign</span>, f <span class="op">=</span> <span class="va">as.character</span>, how <span class="op">=</span> <span class="st">"unlist"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "l"</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="example-3-finding-global-variables">Example 3: Finding global variables<a class="anchor" aria-label="anchor" href="#example-3-finding-global-variables"></a>
</h4>
<p>The <code>codetools</code> package contains
<code>findGlobals()</code> to find all global variables used by a
function. Building on the previous example, we can construct our own
(simplified) version of <code>findGlobals()</code> by searching for any
variable in the body of a function that is not a local variable or a
function argument. More precisely,</p>
<ol style="list-style-type: decimal">
<li><p>We collect the variable names that are <em>not</em> global
variables in a character vector <code>exclude</code>. This includes: the
function arguments; all variables created by assignment as in the
previous example; package names used with <code>::</code> or
<code>:::</code> (e.g. <code>stats</code> in <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">stats::lm()</a></code>);
and variable names used with <code>$</code> or <code>@</code>
(e.g. <code>x$a</code> for a list or <code>x@a</code> for an
S4-object).</p></li>
<li><p>We recurse through the abstract syntax tree similar to the
previous example by discarding all variable names that are elements of
<code>exclude</code> or part of the base environment
(i.e. <code><a href="https://rdrr.io/r/base/environment.html" class="external-link">baseenv()</a></code>). The remaining <em>global</em> variables
are returned as a character vector.</p></li>
</ol>
<p><strong>Remark</strong>: for the sake of simplicity we have not been
completely rigorous in this example. For instance, function arguments of
inline functions are not excluded from the set of global variables.
Also, variable names created by <code><a href="https://rdrr.io/r/base/assign.html" class="external-link">assign()</a></code> or
<code><a href="https://rdrr.io/r/base/delayedAssign.html" class="external-link">delayedAssign()</a></code> could be assigned to
e.g. <code>.GlobalEnv</code>, in which case they should arguably be
recognized as global variables.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## helper function to check for non-global variables</span></span>
<span><span class="va">is_exclude</span> <span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">.xpos</span>, <span class="va">.xsiblings</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">operator</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">.xsiblings</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">.xpos</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">operator</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"&lt;-"</span>, <span class="st">"="</span>, <span class="st">"for"</span>, <span class="st">"assign"</span>, <span class="st">"delayedAssign"</span>, <span class="st">"::"</span>, <span class="st">":::"</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">.xpos</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">operator</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"@"</span>, <span class="st">"$"</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="cn">FALSE</span> </span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## helper function to check for global variables</span></span>
<span><span class="va">is_global</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">exclude</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">xvar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="co">## non-empty element not in exclude or base environment</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nzchar</a></span><span class="op">(</span><span class="va">xvar</span><span class="op">)</span> <span class="op">&amp;&amp;</span> </span>
<span>    <span class="op">!</span><span class="va">xvar</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">exclude</span> <span class="op">&amp;&amp;</span> </span>
<span>    <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists</a></span><span class="op">(</span><span class="va">xvar</span>, envir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">baseenv</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">find_globals</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fun</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">## find local variables to exclude</span></span>
<span>  <span class="va">exclude</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrapply.html">rrapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/body.html" class="external-link">body</a></span><span class="op">(</span><span class="va">fun</span><span class="op">)</span>, condition <span class="op">=</span> <span class="va">is_exclude</span>, f <span class="op">=</span> <span class="va">as.character</span>, how <span class="op">=</span> <span class="st">"unlist"</span><span class="op">)</span></span>
<span>  <span class="va">exclude</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/formals.html" class="external-link">formals</a></span><span class="op">(</span><span class="va">fun</span><span class="op">)</span><span class="op">)</span>, <span class="va">exclude</span><span class="op">)</span></span>
<span>  <span class="co">## find global variables             </span></span>
<span>  <span class="va">globals</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrapply.html">rrapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/body.html" class="external-link">body</a></span><span class="op">(</span><span class="va">fun</span><span class="op">)</span>, classes <span class="op">=</span> <span class="st">"name"</span>, condition <span class="op">=</span> <span class="va">is_global</span>, f <span class="op">=</span> <span class="va">as.character</span>, exclude <span class="op">=</span> <span class="va">exclude</span>, how <span class="op">=</span> <span class="st">"unlist"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">globals</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>To illustrate our newly defined function <code>find_globals()</code>,
let us apply it to the <code><a href="../reference/rrapply.html">rrapply()</a></code> function itself:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">find_globals</span><span class="op">(</span><span class="va">rrapply</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "C_unmelt"  "C_rrapply"</span></span></code></pre></div>
<p><code>C_unmelt()</code> and <code>C_rrapply()</code> are the internal
workhorses of <code><a href="../reference/rrapply.html">rrapply()</a></code> and are part of the
<code>rrapply</code>-package. By default, the codetools
<code>findGlobals()</code> function also returns variable names in the
base package. Discarding all names present in the base package
<code>findGlobals()</code> produces the same result as
<code>find_globals()</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## update existing findGlobals function</span></span>
<span><span class="va">findGlobals2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fun</span>, <span class="va">merge</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">globals</span> <span class="op">&lt;-</span> <span class="fu">codetools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/codetools/man/findGlobals.html" class="external-link">findGlobals</a></span><span class="op">(</span><span class="va">fun</span>, merge <span class="op">=</span> <span class="va">merge</span><span class="op">)</span></span>
<span>  <span class="va">globals</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">globals</span>, <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Negate</a></span><span class="op">(</span><span class="va">exists</span><span class="op">)</span>, envir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">baseenv</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">findGlobals2</span><span class="op">(</span><span class="va">rrapply</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "C_rrapply" "C_unmelt"</span></span></code></pre></div>
<p>Several additional comparisons of <code>find_globals()</code> and
<code>findGlobals2()</code> applied to some common R functions:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## par is part of formals(plot.default)</span></span>
<span><span class="fu">find_globals</span><span class="op">(</span><span class="va">plot.default</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Axis"        "box"         "plot.window" "title"       "xy.coords"  </span></span>
<span><span class="co">#&gt; [6] "dev.hold"    "dev.flush"   "plot.new"    "plot.xy"</span></span>
<span><span class="fu">findGlobals2</span><span class="op">(</span><span class="va">plot.default</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "Axis"        "box"         "dev.flush"   "dev.hold"    "par"        </span></span>
<span><span class="co">#&gt;  [6] "plot.new"    "plot.window" "plot.xy"     "title"       "xy.coords"</span></span>
<span></span>
<span><span class="co">## model.frame is called as stats::model.frame</span></span>
<span><span class="fu">find_globals</span><span class="op">(</span><span class="va">lm</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "model.frame"    "model.response" "model.weights"  "model.offset"  </span></span>
<span><span class="co">#&gt; [5] "is.empty.model" "model.matrix"   "lm.fit"         "lm.wfit"       </span></span>
<span><span class="co">#&gt; [9] ".getXlevels"</span></span>
<span><span class="fu">findGlobals2</span><span class="op">(</span><span class="va">lm</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] ".getXlevels"    "is.empty.model" "lm.fit"         "lm.wfit"       </span></span>
<span><span class="co">#&gt; [5] "model.matrix"   "model.offset"   "model.response" "model.weights"</span></span>
<span></span>
<span><span class="co">## parallel functions are called as parallel::...</span></span>
<span><span class="fu">find_globals</span><span class="op">(</span><span class="fu">boot</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/boot/man/boot.html" class="external-link">boot</a></span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "runif"               "empinf"              "isMatrix"           </span></span>
<span><span class="co">#&gt;  [4] "normalize"           "index.array"         "freq.array"         </span></span>
<span><span class="co">#&gt;  [7] "mclapply"            "makePSOCKcluster"    "clusterSetRNGStream"</span></span>
<span><span class="co">#&gt; [10] "parLapply"           "stopCluster"         "boot.return"</span></span>
<span><span class="fu">findGlobals2</span><span class="op">(</span><span class="fu">boot</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/boot/man/boot.html" class="external-link">boot</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "boot.return" "empinf"      "freq.array"  "index.array" "isMatrix"   </span></span>
<span><span class="co">#&gt; [6] "normalize"   "runif"</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="example-4-plot-abstract-syntax-tree-as-dendrogram">Example 4: Plot abstract syntax tree as dendrogram<a class="anchor" aria-label="anchor" href="#example-4-plot-abstract-syntax-tree-as-dendrogram"></a>
</h4>
<p>To conclude, let us consider plotting abstract syntax trees as
dendrograms. Base R includes a <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> method for dendrogram
objects, therefore it suffices to write a function that allows to
convert expression objects to dendrogram objects. It turns out that a
dendrogram object is defined as a nested list with specific attributes
for each list component to turn it into a dendrogram. As seen
previously, we can convert the abstract syntax tree of an expression
object to a nested list with <code><a href="../reference/rrapply.html">rrapply()</a></code> by setting
<code>how = "list"</code>. In addition, we need to recurse through the
nested list to add the dendrogram specific attributes. To achieve this
for a single node, we define a separate helper function
<code>add_dend_attrs()</code> that distinguishes between branch
(i.e. list) nodes and leaf nodes in the abstract syntax tree.</p>
<p>The <code>height</code> attribute in <code>add_dend_attrs()</code> is
calculated as a function of the depth of the node under evaluation and
the overall maximum depth of the abstract syntax tree. The first can be
obtained via the special argument <code>.xpos</code>, the second is
evaluated by recursing once through the abstract syntax tree with a call
to <code><a href="../reference/rrapply.html">rrapply()</a></code>. To apply <code>add_dend_attrs()</code> to
each (terminal and non-terminal) node of the nested list, we set
<code>classes = c("list", "ANY")</code> and <code>how = "recurse"</code>
in a second call to <code><a href="../reference/rrapply.html">rrapply()</a></code> as explained in
<code><a href="../articles/1-when-to-use-rrapply.html">vignette("1-when-to-use-rrapply")</a></code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## helper function to add dendrogram attributes</span></span>
<span><span class="va">add_dend_attrs</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">.xpos</span>, <span class="va">maxdepth</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">is.list</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">members</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/attributes.html" class="external-link">attributes</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      members <span class="op">=</span> <span class="va">members</span>, </span>
<span>      midpoints <span class="op">=</span> <span class="va">members</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="st">"NULL"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/attributes.html" class="external-link">attributes</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      label <span class="op">=</span> <span class="va">x</span>, </span>
<span>      members <span class="op">=</span> <span class="fl">1</span>, </span>
<span>      leaf <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"height"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">.xpos</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">maxdepth</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## convert expression to dendrogram</span></span>
<span><span class="va">expr_to_dend</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">expr</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">## update maximum depth by assigning to surrounding scope</span></span>
<span>  <span class="va">maxdepth</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">dend1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrapply.html">rrapply</a></span><span class="op">(</span><span class="va">expr</span>, f <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">.xpos</span><span class="op">)</span> <span class="op">{</span> <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">.xpos</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">maxdepth</span><span class="op">)</span> <span class="va">maxdepth</span> <span class="op">&lt;&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">.xpos</span><span class="op">)</span>; <span class="va">x</span> <span class="op">}</span>, how <span class="op">=</span> <span class="st">"list"</span><span class="op">)</span></span>
<span>  <span class="co">## recursively update attributes of each node</span></span>
<span>  <span class="va">dend2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrapply.html">rrapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">dend1</span><span class="op">)</span>, classes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="st">"ANY"</span><span class="op">)</span>, f <span class="op">=</span> <span class="va">add_dend_attrs</span>, maxdepth <span class="op">=</span> <span class="va">maxdepth</span>, how <span class="op">=</span> <span class="st">"recurse"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">dend2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"dendrogram"</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">dend2</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>To test the defined function, we provide as call object the body of
the <code><a href="../reference/rrapply.html">rrapply()</a></code> function itself and pass it to
<code>expr_to_dend()</code> to convert it to a dendrogram:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## plot abstract syntax tree as dendrogram </span></span>
<span><span class="op">(</span><span class="va">rrapply_dend</span> <span class="op">&lt;-</span> <span class="fu">expr_to_dend</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/body.html" class="external-link">body</a></span><span class="op">(</span><span class="va">rrapply</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'dendrogram' with 18 branches and 461 members total, at height 1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rrapply_dend</span>, horiz <span class="op">=</span> <span class="cn">TRUE</span>, type <span class="op">=</span> <span class="st">"triangle"</span>, yaxt <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></span></code></pre></div>
<p><img src="3-calls-and-expressions_files/figure-html/unnamed-chunk-16-1.png" width="100%"></p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Joris Chau.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
