<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Recursive apply for call and expression objects • rrapply</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><link href="../../extra.css" rel="stylesheet">
<meta property="og:title" content="Recursive apply for call and expression objects">
<meta property="og:description" content="rrapply">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">rrapply</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/articles/1-when-to-use-rrapply.html">Efficient list recursion with rrapply</a>
    </li>
    <li>
      <a href="../../articles/articles/2-efficient-melting-unmelting.html">Efficient list melting and unmelting with rrapply</a>
    </li>
    <li>
      <a href="../../articles/articles/3-calls-and-expressions.html">Recursive apply for call and expression objects</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/JorisChau/rrapply/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="3-calls-and-expressions_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Recursive apply for call and expression objects</h1>
                        <h4 class="author">Joris Chau</h4>
            
            <h4 class="date">Latest date: 2020-10-12</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/JorisChau/rrapply/blob/master/vignettes/articles/3-calls-and-expressions.Rmd"><code>vignettes/articles/3-calls-and-expressions.Rmd</code></a></small>
      <div class="hidden name"><code>3-calls-and-expressions.Rmd</code></div>

    </div>

    
    
<div id="expressions" class="section level1">
<h1 class="hasAnchor">
<a href="#expressions" class="anchor"></a>Expressions</h1>
<p>Unevaluated R code is always parsed or captured as a set of <em>expressions</em>, which is a collective term used to refer to any of the following types of objects: scalar constants e.g. <code>TRUE</code> or <code>1</code>, symbols e.g. <code><a href="https://rdrr.io/r/base/substitute.html">quote(x)</a></code>, call objects e.g. <code><a href="https://rdrr.io/r/base/substitute.html">quote(x &lt;- 1)</a></code>, expression vectors e.g. <code><a href="https://rdrr.io/r/base/expression.html">expression(a &lt;- 1, 2 * b)</a></code> or pairlists e.g. <code><a href="https://rdrr.io/r/base/formals.html">formals(seq.default)</a></code>. Call objects and expression vectors are hierarchically structured objects (also called <em>abstract syntax trees</em>) that can be decomposed into symbols and scalar constants as atomic building blocks. For an introduction to expressions and abstract syntax trees, see also the chapter <a href="https://adv-r.hadley.nz/expressions.html" class="uri">https://adv-r.hadley.nz/expressions.html</a>.</p>
<p>Call objects and expression vectors generally behave as nested lists, e.g. subsetting a call object works the same as subsetting a nested list. To illustrate, we can retrieve the abstract syntax tree of a call object by recursing through the object in the same way as for a nested list:</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="co">## recurse through call as nested list</span>
<span class="no">ast</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">expr</span>) {
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">expr</span>, <span class="kw">function</span>(<span class="no">x</span>) {
    <span class="kw">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/call.html">is.call</a></span>(<span class="no">x</span>) <span class="kw">||</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">is.expression</a></span>(<span class="no">x</span>)) {
      <span class="fu">ast</span>(<span class="no">x</span>)
    } <span class="kw">else</span> {
      <span class="no">x</span>
    }
  })
}

<span class="co">## decompose call object</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="fu">ast</span>(<span class="fu"><a href="https://rdrr.io/r/base/substitute.html">quote</a></span>(<span class="no">y</span> <span class="kw">&lt;-</span> <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fl">1</span> + <span class="fl">TRUE</span>)))
<span class="co">#&gt; List of 3</span>
<span class="co">#&gt;  $ : symbol &lt;-</span>
<span class="co">#&gt;  $ : symbol y</span>
<span class="co">#&gt;  $ :List of 3</span>
<span class="co">#&gt;   ..$ : symbol &lt;-</span>
<span class="co">#&gt;   ..$ : symbol x</span>
<span class="co">#&gt;   ..$ :List of 3</span>
<span class="co">#&gt;   .. ..$ : symbol +</span>
<span class="co">#&gt;   .. ..$ : num 1</span>
<span class="co">#&gt;   .. ..$ : logi TRUE</span></pre></body></html></div>
<p>Given this information, we might expect that base <code><a href="https://rdrr.io/r/base/rapply.html">rapply()</a></code> also recurses through call objects and expression vectors in the same way as for nested lists, but this is unfortunately not the case. To be precise, <code><a href="https://rdrr.io/r/base/rapply.html">rapply()</a></code> does accept expression vectors as input, but effectively treats them as flat lists of call objects similar to <code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code>. Call objects are not accepted at all by <code><a href="https://rdrr.io/r/base/rapply.html">rapply()</a></code> and return an error.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="co">## rapply on an expression vector</span>
<span class="fu"><a href="https://rdrr.io/r/base/rapply.html">rapply</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="no">y</span> <span class="kw">&lt;-</span> <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fl">1</span>, <span class="fu">f</span>(<span class="fu">g</span>(<span class="fl">2</span> * <span class="no">pi</span>))), <span class="kw">f</span> <span class="kw">=</span> <span class="no">identity</span>)
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; y &lt;- x &lt;- 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; f(g(2 * pi))</span>

<span class="co">## lapply on an expression vector</span>
<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="no">y</span> <span class="kw">&lt;-</span> <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fl">1</span>, <span class="fu">f</span>(<span class="fu">g</span>(<span class="fl">2</span> * <span class="no">pi</span>))), <span class="kw">FUN</span> <span class="kw">=</span> <span class="no">identity</span>)
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; y &lt;- x &lt;- 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; f(g(2 * pi))</span>

<span class="co">## rapply on a call object (not ok!) </span>
<span class="fu"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span>({
  <span class="fu"><a href="https://rdrr.io/r/base/rapply.html">rapply</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/substitute.html">quote</a></span>(<span class="no">y</span> <span class="kw">&lt;-</span> <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fl">1</span>), <span class="kw">f</span> <span class="kw">=</span> <span class="no">identity</span>)
}, <span class="kw">error</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">error</span>) <span class="no">error</span>$<span class="no">message</span>)
<span class="co">#&gt; [1] "'object' must be a list or expression"</span></pre></body></html></div>
</div>
<div id="expressions-and-rrapply" class="section level1">
<h1 class="hasAnchor">
<a href="#expressions-and-rrapply" class="anchor"></a>Expressions and <code>rrapply()</code>
</h1>
<p>Starting from version 1.2.0 <code><a href="../../reference/rrapply.html">rrapply()</a></code> also supports recursion of call objects and expression vectors, which are treated as nested lists based on their internal abstract syntax trees. As such, all functionality described in <code><a href="../../articles/articles/1-when-to-use-rrapply.html">vignette("1-when-to-use-rrapply")</a></code> extends directly to call objects and expression vectors.</p>
<div id="structuring-the-result" class="section level2">
<h2 class="hasAnchor">
<a href="#structuring-the-result" class="anchor"></a>Structuring the result</h2>
<p>When applying <code><a href="../../reference/rrapply.html">rrapply()</a></code> (or base <code><a href="https://rdrr.io/r/base/rapply.html">rapply()</a></code>) to nested lists the difference between <code>how = "replace"</code> and <code>how = "list"</code> is relatively minor. Both choices return a nested list, but only <code>how = "list"</code> replaces elements not subject to <code>f</code> by the argument <code>deflt</code>. For call objects and expression objects, the difference is more important as <code>how = "replace"</code> always maintains the type of the object after application of <code><a href="../../reference/rrapply.html">rrapply()</a></code>, whereas <code>how = "list"</code> returns the object formatted as a nested list.</p>
<p>With <code>how = "replace"</code>, we can for instance directly update the abstract syntax tree of a call object:</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">rrapply</span>)

<span class="no">call_old</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">quote</a></span>(<span class="no">y</span> <span class="kw">&lt;-</span> <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fl">1</span> + <span class="fl">TRUE</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">call_old</span>)
<span class="co">#&gt;  language y &lt;- x &lt;- 1 + TRUE</span>

<span class="co">## update call object</span>
<span class="no">call_new</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(<span class="no">call_old</span>, <span class="kw">classes</span> <span class="kw">=</span> <span class="st">"logical"</span>, <span class="kw">f</span> <span class="kw">=</span> <span class="no">as.numeric</span>, <span class="kw">how</span> <span class="kw">=</span> <span class="st">"replace"</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">call_new</span>)
<span class="co">#&gt;  language y &lt;- x &lt;- 1 + 1</span></pre></body></html></div>
<p>Using <code>how = "list"</code>, we can update the abstract syntax tree and return it as a nested list:</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="co">## update and decompose call object</span>
<span class="no">call_ast</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(<span class="no">call_old</span>, <span class="kw">f</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/logical.html">is.logical</a></span>(<span class="no">x</span>), <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">x</span>), <span class="no">x</span>), <span class="kw">how</span> <span class="kw">=</span> <span class="st">"list"</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">call_ast</span>)
<span class="co">#&gt; List of 3</span>
<span class="co">#&gt;  $ : symbol &lt;-</span>
<span class="co">#&gt;  $ : symbol y</span>
<span class="co">#&gt;  $ :List of 3</span>
<span class="co">#&gt;   ..$ : symbol &lt;-</span>
<span class="co">#&gt;   ..$ : symbol x</span>
<span class="co">#&gt;   ..$ :List of 3</span>
<span class="co">#&gt;   .. ..$ : symbol +</span>
<span class="co">#&gt;   .. ..$ : num 1</span>
<span class="co">#&gt;   .. ..$ : num 1</span></pre></body></html></div>
<p><strong>Remark</strong>: Note that in the second function call we did not use <code>classes = "logical"</code> to avoid that all list elements that are not of class <code>"logical"</code> are replaced by the <code>deflt</code> argument (<code>NULL</code>).</p>
<p>The choices <code>how = "prune"</code>, <code>how = "flatten"</code> and <code>how = "melt"</code> return the pruned abstract syntax tree as: a nested list, a flattened list and a melted data.frame respectively. This is identical to application of <code><a href="../../reference/rrapply.html">rrapply()</a></code> to the abstract syntax tree formatted as a nested list. To illustrate, let us return all names in the abstract syntax tree of an expression vector that are not part of base R.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="co">## example expression</span>
<span class="no">expr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="no">y</span> <span class="kw">&lt;-</span> <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fl">1</span>, <span class="fu">f</span>(<span class="fu">g</span>(<span class="fl">2</span> * <span class="no">pi</span>)))
<span class="co">## check if name is not in base environment</span>
<span class="no">is_new_name</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) !<span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="no">x</span>), <span class="kw">envir</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html">baseenv</a></span>())

<span class="co">## prune and decompose expression</span>
<span class="no">expr_prune</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(<span class="no">expr</span>, <span class="kw">classes</span> <span class="kw">=</span> <span class="st">"name"</span>, <span class="kw">condition</span> <span class="kw">=</span> <span class="no">is_new_name</span>, <span class="kw">how</span> <span class="kw">=</span> <span class="st">"prune"</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">expr_prune</span>)
<span class="co">#&gt; List of 2</span>
<span class="co">#&gt;  $ :List of 2</span>
<span class="co">#&gt;   ..$ : symbol y</span>
<span class="co">#&gt;   ..$ :List of 1</span>
<span class="co">#&gt;   .. ..$ : symbol x</span>
<span class="co">#&gt;  $ :List of 2</span>
<span class="co">#&gt;   ..$ : symbol f</span>
<span class="co">#&gt;   ..$ :List of 1</span>
<span class="co">#&gt;   .. ..$ : symbol g</span>

<span class="co">## prune and flatten expression</span>
<span class="no">expr_flatten</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(<span class="no">expr</span>, <span class="kw">classes</span> <span class="kw">=</span> <span class="st">"name"</span>, <span class="kw">condition</span> <span class="kw">=</span> <span class="no">is_new_name</span>, <span class="kw">how</span> <span class="kw">=</span> <span class="st">"flatten"</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">expr_flatten</span>)
<span class="co">#&gt; List of 4</span>
<span class="co">#&gt;  $ : symbol y</span>
<span class="co">#&gt;  $ : symbol x</span>
<span class="co">#&gt;  $ : symbol f</span>
<span class="co">#&gt;  $ : symbol g</span>

<span class="co">## prune and melt expression</span>
<span class="no">expr_melt</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(<span class="no">expr</span>, <span class="kw">classes</span> <span class="kw">=</span> <span class="st">"name"</span>, <span class="kw">condition</span> <span class="kw">=</span> <span class="no">is_new_name</span>, <span class="kw">how</span> <span class="kw">=</span> <span class="st">"melt"</span>)
<span class="no">expr_melt</span>
<span class="co">#&gt;    L1  L2   L3 value</span>
<span class="co">#&gt; 1 ..1 ..2 &lt;NA&gt;     y</span>
<span class="co">#&gt; 2 ..1 ..3  ..2     x</span>
<span class="co">#&gt; 3 ..2 ..1 &lt;NA&gt;     f</span>
<span class="co">#&gt; 4 ..2 ..2  ..1     g</span></pre></body></html></div>
</div>
<div id="additional-code-examples" class="section level2">
<h2 class="hasAnchor">
<a href="#additional-code-examples" class="anchor"></a>Additional code examples</h2>
<p>This section provides several worked out code examples using <code><a href="../../reference/rrapply.html">rrapply()</a></code> to recurse through the abstract syntax tree of a call object, mainly inspired by the <code>codetools</code> package and the chapter <a href="https://adv-r.hadley.nz/expressions.html#ast-funs" class="uri">https://adv-r.hadley.nz/expressions.html#ast-funs</a>. Note that all examples can also be rewritten using recursive function definitions in base R, but the use of <code><a href="../../reference/rrapply.html">rrapply()</a></code> makes the code more concise and easier to follow and reason about. The examples are ordered in increasing degrees of code complexity.</p>
<div id="example-1-replacing-t-and-f" class="section level3">
<h3 class="hasAnchor">
<a href="#example-1-replacing-t-and-f" class="anchor"></a>Example 1: Replacing <code>T</code> and <code>F</code>
</h3>
<p>In <a href="https://adv-r.hadley.nz/expressions.html#ast-funs" class="uri">https://adv-r.hadley.nz/expressions.html#ast-funs</a>, to demonstrate recursion of the abstract syntax tree of an expression, a recursive function <code>logical_abbr()</code> is defined to check for the presence of the logical abbreviations <code>T</code> and <code>F</code> in an expression object:</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="co">## recursive function to check for T or F</span>
<span class="no">logical_abbr</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) {
  <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/is.recursive.html">is.atomic</a></span>(<span class="no">x</span>)) {
    <span class="fl">FALSE</span>
  } <span class="kw">else</span> <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/name.html">is.name</a></span>(<span class="no">x</span>)) {
    <span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span>(<span class="no">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">quote</a></span>(<span class="no">T</span>)) <span class="kw">||</span> <span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span>(<span class="no">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">quote</a></span>(<span class="no">F</span>))
  } <span class="kw">else</span> <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/call.html">is.call</a></span>(<span class="no">x</span>) <span class="kw">||</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">is.pairlist</a></span>(<span class="no">x</span>)) {
    <span class="kw">for</span> (<span class="no">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span>(<span class="no">x</span>)) {
      <span class="kw">if</span> (<span class="fu">logical_abbr</span>(<span class="no">x</span><span class="kw">[[</span><span class="no">i</span>]])) <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fl">TRUE</span>)
    }
    <span class="fl">FALSE</span>
  } <span class="kw">else</span> {
    <span class="fu"><a href="https://rdrr.io/r/base/stop.html">stop</a></span>(<span class="st">"Don't know how to handle type "</span>, <span class="fu"><a href="https://rdrr.io/r/base/typeof.html">typeof</a></span>(<span class="no">x</span>),
         <span class="kw">call.</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
  }
}

<span class="no">call1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">quote</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">x</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="no">T</span>))
<span class="no">call2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">quote</a></span>(<span class="fu">f</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">TRUE</span>, <span class="fl">FALSE</span>)))

<span class="co">## containing a logical abbreviation</span>
<span class="fu">logical_abbr</span>(<span class="no">call1</span>)
<span class="co">#&gt; [1] TRUE</span>
<span class="co">## not containing a logical abbreviation</span>
<span class="fu">logical_abbr</span>(<span class="no">call2</span>)
<span class="co">#&gt; [1] FALSE</span></pre></body></html></div>
<p>Let us revisit this example to not only find, but also replace any logical abbreviations by their non-abbreviated counterparts. Using <code><a href="../../reference/rrapply.html">rrapply()</a></code>, we should set <code>how = "replace"</code> in order to maintain the original object type after updating the abstract syntax tree:</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="co">## expand logical abbreviation</span>
<span class="no">logical_abbr_expand</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) {
  <span class="kw">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span>(<span class="no">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">quote</a></span>(<span class="no">T</span>))) {
    <span class="fl">TRUE</span>
  } <span class="kw">else</span> <span class="kw">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span>(<span class="no">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">quote</a></span>(<span class="no">F</span>))) {
    <span class="fl">FALSE</span>
  } <span class="kw">else</span> {
    <span class="no">x</span>
  }
}

<span class="no">call3</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="fu">f</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">T</span>, <span class="no">F</span>)), <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span>(<span class="no">T</span>, <span class="fl">FALSE</span>))

<span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(<span class="no">call1</span>, <span class="kw">f</span> <span class="kw">=</span> <span class="no">logical_abbr_expand</span>, <span class="kw">how</span> <span class="kw">=</span> <span class="st">"replace"</span>)
<span class="co">#&gt; mean(x, na.rm = TRUE)</span>
<span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(<span class="no">call3</span>, <span class="kw">f</span> <span class="kw">=</span> <span class="no">logical_abbr_expand</span>, <span class="kw">how</span> <span class="kw">=</span> <span class="st">"replace"</span>)
<span class="co">#&gt; expression(f(x = c(TRUE, FALSE)), any(TRUE, FALSE))</span></pre></body></html></div>
</div>
<div id="example-2-finding-local-variables" class="section level3">
<h3 class="hasAnchor">
<a href="#example-2-finding-local-variables" class="anchor"></a>Example 2: Finding local variables</h3>
<p>A second demonstrating example of abstract syntax tree recursion in <a href="https://adv-r.hadley.nz/expressions.html#ast-funs" class="uri">https://adv-r.hadley.nz/expressions.html#ast-funs</a> deals with finding all variables in an expression created by assignment. The recursive function <code>find_assign()</code> finds all variables created by assignment with <code>&lt;-</code> and returns them as a character vector:</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">find_assign</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) {
  <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/is.recursive.html">is.atomic</a></span>(<span class="no">x</span>) <span class="kw">||</span> <span class="fu"><a href="https://rdrr.io/r/base/name.html">is.name</a></span>(<span class="no">x</span>)) {
    <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span>()
  } <span class="kw">else</span> <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/call.html">is.call</a></span>(<span class="no">x</span>)) {
    <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span>(<span class="no">x</span><span class="kw">[[</span><span class="fl">1</span>]], <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">quote</a></span>(<span class="no">`&lt;-`</span>)) <span class="kw">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/name.html">is.name</a></span>(<span class="no">x</span><span class="kw">[[</span><span class="fl">2</span>]])) {
      <span class="no">lhs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="no">x</span><span class="kw">[[</span><span class="fl">2</span>]])
    } <span class="kw">else</span> {
      <span class="no">lhs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span>()
    }
    <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">lhs</span>, <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">x</span>, <span class="no">find_assign</span>))))
  } <span class="kw">else</span> <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/list.html">is.pairlist</a></span>(<span class="no">x</span>)) {
    <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">x</span>, <span class="no">find_assign</span>)))
  } <span class="kw">else</span> {
    <span class="fu"><a href="https://rdrr.io/r/base/stop.html">stop</a></span>(<span class="st">"Don't know how to handle type "</span>, <span class="fu"><a href="https://rdrr.io/r/base/typeof.html">typeof</a></span>(<span class="no">x</span>), <span class="kw">call.</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
  }
}

<span class="no">call4</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">quote</a></span>({
  <span class="no">l</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>()
  <span class="no">l</span>$<span class="no">a</span> <span class="kw">&lt;-</span> <span class="fl">5</span>
  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">l</span>) <span class="kw">&lt;-</span> <span class="st">"b"</span>
})

<span class="fu">find_assign</span>(<span class="no">call4</span>)
<span class="co">#&gt; [1] "l"</span></pre></body></html></div>
<p>Revisiting this example using <code><a href="../../reference/rrapply.html">rrapply()</a></code>, we essentially need to filter any name (i.e. symbol) that is the second element of a call to <code>&lt;-</code>. Checking the position of the element in the call can be done with the special <code>.xpos</code> argument. To verify that the first element of the call is an actual assignment, we can make use of the special <code>.xsiblings</code> argument. We slightly generalize the <code>find_assign()</code> function to also return variables created by <code>=</code>, <code>for</code>, <code>assign</code> or <code>delayedAssign</code>.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="co">## helper function to check if variable is created by assignment</span>
<span class="no">is_assign</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>, <span class="no">.xpos</span>, <span class="no">.xsiblings</span>) {
  <span class="co">## element is second in call</span>
  <span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span>(<span class="no">.xpos</span>[<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">.xpos</span>)], <span class="fl">2L</span>) <span class="kw">&amp;&amp;</span>
    <span class="co">## first element in call is assignment</span>
    <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="no">.xsiblings</span><span class="kw">[[</span><span class="fl">1</span>]]) <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"&lt;-"</span>, <span class="st">"="</span>, <span class="st">"for"</span>, <span class="st">"assign"</span>, <span class="st">"delayedAssign"</span>)
}

<span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(<span class="no">call4</span>, <span class="kw">condition</span> <span class="kw">=</span> <span class="no">is_assign</span>, <span class="kw">f</span> <span class="kw">=</span> <span class="no">as.character</span>, <span class="kw">how</span> <span class="kw">=</span> <span class="st">"unlist"</span>)
<span class="co">#&gt; [1] "l"</span></pre></body></html></div>
</div>
<div id="example-3-finding-global-variables" class="section level3">
<h3 class="hasAnchor">
<a href="#example-3-finding-global-variables" class="anchor"></a>Example 3: Finding global variables</h3>
<p>The <code>codetools</code> package contains <code>findGlobals()</code> to find all global variables used by a function. Building on the previous example, we can construct our own (simplified) version of <code>findGlobals()</code> by searching for any variable in the body of a function that is not a local variable or a function argument. More precisely,</p>
<ol style="list-style-type: decimal">
<li><p>We collect the variable names that are <em>not</em> global variables in a character vector <code>exclude</code>. This includes: the function arguments; all variables created by assignment as in the previous example; package names used with <code>::</code> or <code>:::</code> (e.g. <code>stats</code> in <code><a href="https://rdrr.io/r/stats/lm.html">stats::lm()</a></code>); and variable names used with <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code> or <code>@</code> (e.g. <code>x$a</code> for a list or <code>x@a</code> for an S4-object).</p></li>
<li><p>We recurse through the abstract syntax tree similar to the previous example by discarding all variable names that are elements of <code>exclude</code> or part of the base environment (i.e. <code><a href="https://rdrr.io/r/base/environment.html">baseenv()</a></code>). The remaining <em>global</em> variables are returned as a character vector.</p></li>
</ol>
<p><strong>Remark</strong>: For the sake of simplicity, we have not been completely rigorous in this example. For instance, function arguments of inline functions are not excluded from the set of global variables. Also, variable names created by <code><a href="https://rdrr.io/r/base/assign.html">assign()</a></code> or <code><a href="https://rdrr.io/r/base/delayedAssign.html">delayedAssign()</a></code> could be assigned to e.g. <code>.GlobalEnv</code>, in which case they should arguably be recognized as global variables.</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="co">## helper function to check for non-global variables</span>
<span class="no">is_exclude</span> <span class="kw">&lt;-</span><span class="kw">function</span>(<span class="no">x</span>, <span class="no">.xpos</span>, <span class="no">.xsiblings</span>) {
  (<span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span>(<span class="no">.xpos</span>[<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">.xpos</span>)], <span class="fl">2L</span>) <span class="kw">&amp;&amp;</span>
     <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="no">.xsiblings</span><span class="kw">[[</span><span class="fl">1</span>]]) <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"&lt;-"</span>, <span class="st">"="</span>, <span class="st">"for"</span>, <span class="st">"assign"</span>, <span class="st">"delayedAssign"</span>, <span class="st">"::"</span>, <span class="st">":::"</span>)) <span class="kw">||</span>
    (<span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span>(<span class="no">.xpos</span>[<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">.xpos</span>)], <span class="fl">3L</span>) <span class="kw">&amp;&amp;</span>
       <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="no">.xsiblings</span><span class="kw">[[</span><span class="fl">1</span>]]) <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"@"</span>, <span class="st">"$"</span>))
}

<span class="co">## helper function to check for global variables</span>
<span class="no">is_global</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>, <span class="no">exclude</span>) {
  !<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="no">x</span>) <span class="kw">&amp;&amp;</span>
    <span class="fu"><a href="https://rdrr.io/r/base/nchar.html">nzchar</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="no">x</span>)) <span class="kw">&amp;&amp;</span>
    !<span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="no">x</span>) <span class="kw">%in%</span> <span class="no">exclude</span> <span class="kw">&amp;&amp;</span>
    !<span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="no">x</span>), <span class="kw">envir</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html">baseenv</a></span>())
}

<span class="no">find_globals</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">fun</span>) {
  <span class="co">## find variables to exclude</span>
  <span class="no">exclude</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/body.html">body</a></span>(<span class="no">fun</span>), <span class="kw">condition</span> <span class="kw">=</span> <span class="no">is_exclude</span>, <span class="kw">f</span> <span class="kw">=</span> <span class="no">as.character</span>, <span class="kw">how</span> <span class="kw">=</span> <span class="st">"unlist"</span>)
  <span class="no">exclude</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/formals.html">formals</a></span>(<span class="no">fun</span>)), <span class="no">exclude</span>)
  <span class="co">## find global variables             </span>
  <span class="no">globals</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/body.html">body</a></span>(<span class="no">fun</span>), <span class="kw">classes</span> <span class="kw">=</span> <span class="st">"name"</span>, <span class="kw">condition</span> <span class="kw">=</span> <span class="no">is_global</span>, <span class="kw">f</span> <span class="kw">=</span> <span class="no">as.character</span>, <span class="kw">exclude</span> <span class="kw">=</span> <span class="no">exclude</span>, <span class="kw">how</span> <span class="kw">=</span> <span class="st">"unlist"</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="no">globals</span>))
}</pre></body></html></div>
<p>To illustrate our newly defined function <code>find_globals()</code>, let us apply it to the <code><a href="../../reference/rrapply.html">rrapply()</a></code> function itself:</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu">find_globals</span>(<span class="no">rrapply</span>)
<span class="co">#&gt; [1] "C_unmelt"  "C_rrapply"</span></pre></body></html></div>
<p><code>C_unmelt()</code> and <code>C_rrapply()</code> are the internal workhorses of <code><a href="../../reference/rrapply.html">rrapply()</a></code> and are part of the <code>rrapply</code>-package. By default, the codetools <code>findGlobals()</code> function also returns variable names in the base package. Discarding all names present in the base package <code>findGlobals()</code> produces the same result as <code>find_globals()</code>:</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="co">## update existing findGlobals function</span>
<span class="no">findGlobals2</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">fun</span>, <span class="no">merge</span> <span class="kw">=</span> <span class="fl">TRUE</span>) {
  <span class="no">globals</span> <span class="kw">&lt;-</span> <span class="kw pkg">codetools</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/codetools/man/findGlobals.html">findGlobals</a></span>(<span class="no">fun</span>, <span class="kw">merge</span> <span class="kw">=</span> <span class="no">merge</span>)
  <span class="no">globals</span>[<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">globals</span>, <span class="fu"><a href="https://rdrr.io/r/base/funprog.html">Negate</a></span>(<span class="no">exists</span>), <span class="kw">envir</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html">baseenv</a></span>())]
}

<span class="fu">findGlobals2</span>(<span class="no">rrapply</span>)
<span class="co">#&gt; [1] "C_rrapply" "C_unmelt"</span></pre></body></html></div>
<p>Several additional comparisons of <code>find_globals()</code> and <code>findGlobals2()</code> applied to some common R functions:</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="co">## par is part of formals(plot.default)</span>
<span class="fu">find_globals</span>(<span class="no">plot.default</span>)
<span class="co">#&gt; [1] "Axis"        "box"         "plot.window" "title"       "xy.coords"  </span>
<span class="co">#&gt; [6] "dev.hold"    "dev.flush"   "plot.new"    "plot.xy"</span>
<span class="fu">findGlobals2</span>(<span class="no">plot.default</span>)
<span class="co">#&gt;  [1] "Axis"        "box"         "dev.flush"   "dev.hold"    "par"        </span>
<span class="co">#&gt;  [6] "plot.new"    "plot.window" "plot.xy"     "title"       "xy.coords"</span>

<span class="co">## model.frame is present as stats::model.frame</span>
<span class="fu">find_globals</span>(<span class="no">lm</span>)
<span class="co">#&gt; [1] "model.frame"    "model.response" "model.weights"  "model.offset"  </span>
<span class="co">#&gt; [5] "is.empty.model" "model.matrix"   "lm.fit"         "lm.wfit"       </span>
<span class="co">#&gt; [9] ".getXlevels"</span>
<span class="fu">findGlobals2</span>(<span class="no">lm</span>)
<span class="co">#&gt; [1] ".getXlevels"    "is.empty.model" "lm.fit"         "lm.wfit"       </span>
<span class="co">#&gt; [5] "model.matrix"   "model.offset"   "model.response" "model.weights"</span>

<span class="co">## parallel functions are present as parallel::...</span>
<span class="fu">find_globals</span>(<span class="kw pkg">boot</span><span class="kw ns">::</span><span class="no"><a href="https://rdrr.io/pkg/boot/man/boot.html">boot</a></span>)
<span class="co">#&gt;  [1] "runif"               "empinf"              "isMatrix"           </span>
<span class="co">#&gt;  [4] "normalize"           "index.array"         "freq.array"         </span>
<span class="co">#&gt;  [7] "mclapply"            "makePSOCKcluster"    "clusterSetRNGStream"</span>
<span class="co">#&gt; [10] "parLapply"           "stopCluster"         "boot.return"</span>
<span class="fu">findGlobals2</span>(<span class="kw pkg">boot</span><span class="kw ns">::</span><span class="no"><a href="https://rdrr.io/pkg/boot/man/boot.html">boot</a></span>)
<span class="co">#&gt; [1] "boot.return" "empinf"      "freq.array"  "index.array" "isMatrix"   </span>
<span class="co">#&gt; [6] "normalize"   "runif"</span></pre></body></html></div>
</div>
<div id="example-4-plot-abstract-syntax-tree-as-dendrogram" class="section level3">
<h3 class="hasAnchor">
<a href="#example-4-plot-abstract-syntax-tree-as-dendrogram" class="anchor"></a>Example 4: Plot abstract syntax tree as dendrogram</h3>
<p>To conclude, let us consider plotting abstract syntax trees as dendrograms. Base R includes a <code><a href="https://rdrr.io/r/base/plot.html">plot()</a></code> method for dendrogram objects, therefore it suffices to write a function that allows to convert expression objects to dendrogram objects. It turns out that a dendrogram object is defined as a nested list with specific attributes for each list component to turn it into a dendrogram. As seen previously, we can convert the abstract syntax tree of an expression object to a nested list with <code><a href="../../reference/rrapply.html">rrapply()</a></code> by setting <code>how = "list"</code>. In addition, we need to recurse through the nested list to add the dendrogram specific attributes. To achieve this for a single node, we define a separate helper function <code>add_dend_attrs()</code> that distinguishes between branch (i.e. list) nodes and leaf nodes in the abstract syntax tree.</p>
<p>The <code>height</code> attribute in <code>add_dend_attrs()</code> is calculated as a function of the depth of the node under evaluation and the overall maximum depth of the abstract syntax tree. The first can be obtained via the special argument <code>.xpos</code>, the second is evaluated by recursing once through the abstract syntax tree with a call to <code><a href="../../reference/rrapply.html">rrapply()</a></code>. To apply <code>add_dend_attrs()</code> to each node of the nested list, we set <code>feverywhere = "recurse"</code> in a second call to <code><a href="../../reference/rrapply.html">rrapply()</a></code> as explained in <code><a href="../../articles/articles/1-when-to-use-rrapply.html">vignette("1-when-to-use-rrapply")</a></code>.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="co">## helper function to add dendrogram attributes</span>
<span class="no">add_dend_attrs</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>, <span class="no">.xpos</span>, <span class="no">maxdepth</span>) {
  <span class="kw">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span>(<span class="no">x</span>)) {
    <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html">rev</a></span>(<span class="no">x</span>)
    <span class="no">members</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="no">x</span>))
    <span class="fu"><a href="https://rdrr.io/r/base/attributes.html">attributes</a></span>(<span class="no">x</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
      <span class="kw">members</span> <span class="kw">=</span> <span class="no">members</span>,
      <span class="kw">midpoints</span> <span class="kw">=</span> <span class="no">members</span> - <span class="fl">1</span>
    )
  } <span class="kw">else</span> {
    <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(!<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="no">x</span>), <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="no">x</span>), <span class="st">"NULL"</span>)
    <span class="fu"><a href="https://rdrr.io/r/base/attributes.html">attributes</a></span>(<span class="no">x</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
      <span class="kw">label</span> <span class="kw">=</span> <span class="no">x</span>,
      <span class="kw">members</span> <span class="kw">=</span> <span class="fl">1</span>,
      <span class="kw">leaf</span> <span class="kw">=</span> <span class="fl">TRUE</span>
    )
  }
  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span>(<span class="no">x</span>, <span class="st">"height"</span>) <span class="kw">&lt;-</span> <span class="fl">1</span> + (<span class="fl">1</span> - <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">.xpos</span>)) / <span class="no">maxdepth</span>
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">x</span>)
}

<span class="co">## convert expression to dendrogram</span>
<span class="no">expr_to_dend</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">expr</span>) {
  <span class="no">maxdepth</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">integer</a></span>(<span class="fl">1</span>)
  <span class="no">dend1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(<span class="no">expr</span>, <span class="kw">f</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">x</span>, <span class="no">.xpos</span>) { <span class="kw">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">.xpos</span>) <span class="kw">&gt;</span> <span class="no">maxdepth</span>) <span class="no">maxdepth</span> <span class="kw">&lt;&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">.xpos</span>); <span class="no">x</span> }, <span class="kw">how</span> <span class="kw">=</span> <span class="st">"list"</span>)
  <span class="no">dend2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">dend1</span>), <span class="kw">f</span> <span class="kw">=</span> <span class="no">add_dend_attrs</span>, <span class="kw">maxdepth</span> <span class="kw">=</span> <span class="no">maxdepth</span>, <span class="kw">feverywhere</span> <span class="kw">=</span> <span class="st">"recurse"</span>)<span class="kw">[[</span><span class="fl">1</span>]]
  <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span>(<span class="no">dend2</span>) <span class="kw">&lt;-</span> <span class="st">"dendrogram"</span>
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">dend2</span>)
}</pre></body></html></div>
<p>To test the defined function, we provide as call object the body of the <code><a href="../../reference/rrapply.html">rrapply()</a></code> function itself and pass it to <code>expr_to_dend()</code> to convert it to a dendrogram:</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="co">## plot abstract syntax tree as dendrogram </span>
(<span class="no">rrapply_dend</span> <span class="kw">&lt;-</span> <span class="fu">expr_to_dend</span>(<span class="fu"><a href="https://rdrr.io/r/base/body.html">body</a></span>(<span class="no">rrapply</span>)))
<span class="co">#&gt; 'dendrogram' with 14 branches and 318 members total, at height 1</span>
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">rrapply_dend</span>, <span class="kw">horiz</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"triangle"</span>, <span class="kw">yaxt</span> <span class="kw">=</span> <span class="st">"n"</span>)</pre></body></html></div>
<p><img src="3-calls-and-expressions_files/figure-html/unnamed-chunk-16-1.png" width="100%"></p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Joris Chau.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
