<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Efficient list melting and unnesting with rrapply • rrapply</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><link href="../../extra.css" rel="stylesheet">
<meta property="og:title" content="Efficient list melting and unnesting with rrapply">
<meta property="og:description" content="rrapply">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">rrapply</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.2.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/articles/1-when-to-use-rrapply.html">Efficient list recursion with rrapply</a>
    </li>
    <li>
      <a href="../../articles/articles/2-efficient-melting-unnesting.html">Efficient list melting and unnesting with rrapply</a>
    </li>
    <li>
      <a href="../../articles/articles/3-calls-and-expressions.html">Recursive apply for call and expression objects</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/JorisChau/rrapply/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="2-efficient-melting-unnesting_files/accessible-code-block-0.0.1/empty-anchor.js"></script><link href="2-efficient-melting-unnesting_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="2-efficient-melting-unnesting_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Efficient list melting and unnesting with rrapply</h1>
                        <h4 class="author">Joris Chau</h4>
            
            <h4 class="date">Latest date: 2021-01-25</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/JorisChau/rrapply/blob/master/vignettes/articles/2-efficient-melting-unnesting.Rmd"><code>vignettes/articles/2-efficient-melting-unnesting.Rmd</code></a></small>
      <div class="hidden name"><code>2-efficient-melting-unnesting.Rmd</code></div>

    </div>

    
    
<div id="efficient-list-unnesting" class="section level1">
<h1 class="hasAnchor">
<a href="#efficient-list-unnesting" class="anchor"></a>Efficient list unnesting</h1>
<p>The tutorial <code><a href="../../articles/articles/1-when-to-use-rrapply.html">vignette("1-when-to-use-rrapply")</a></code> describes the use of <code><a href="../../reference/rrapply.html">rrapply()</a></code> when applied directly to data formatted as a nested list. If there is no specific reason to keep the data in the form of a nested list, it is often more practical to transform the nested list into a more manageable rectangular format and execute any further data processing steps on the unnested object (e.g. a data.frame). For this purpose, <code><a href="../../reference/rrapply.html">rrapply()</a></code> includes the options <code>how = "melt"</code> and <code>how = "bind"</code> to unnest a nested list either to a <em>long</em> or a <em>wide</em> data.frame. The following sections explain these two options in more detail and provide several examples on their usage.</p>
<div id="unnest-to-long-data-frame-with-how-melt" class="section level2">
<h2 class="hasAnchor">
<a href="#unnest-to-long-data-frame-with-how-melt" class="anchor"></a>Unnest to long data.frame with <code>how = "melt"</code>
</h2>
<p>The option <code>how = "melt"</code> unnests a nested list to a <em>long</em> or melted data.frame similar in format to <code><a href="https://rdrr.io/pkg/reshape2/man/melt.html">reshape2::melt()</a></code> applied to a nested list. The rows of the melted data.frame contain the individual node paths of the elements in the nested list after pruning (based on the <code>condition</code> or <code>classes</code> arguments). The <code>"value"</code> column is a vector- or list-column with the values of the terminal nodes identical to the result returned by <code>how = "flatten"</code>, see also <code><a href="../../articles/articles/1-when-to-use-rrapply.html">vignette("1-when-to-use-rrapply")</a></code>.</p>
<p>In comparison to <code><a href="https://rdrr.io/pkg/reshape2/man/melt.html">reshape2::melt()</a></code>, <code><a href="../../reference/rrapply.html">rrapply()</a></code> provides additional flexibility to filter or transform specific list elements before melting a nested list using e.g. the <code>f</code>, <code>classes</code> or <code>condition</code> arguments. More importantly, <code><a href="../../reference/rrapply.html">rrapply()</a></code> is optimized specifically for nested lists, whereas <code><a href="https://rdrr.io/pkg/reshape2/man/melt.html">reshape2::melt()</a></code> was mainly aimed at melting data.frames before it was superseded by <code><a href="https://tidyr.tidyverse.org/reference/gather.html">tidyr::gather()</a></code> and the more recent <code><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">tidyr::pivot_longer()</a></code>. For this reason, <code><a href="https://rdrr.io/pkg/reshape2/man/melt.html">reshape2::melt()</a></code> tends to be quite slow when applied to larger nested lists.</p>
<p>For illustration purposes, we use the same dataset <code>renewable_energy_by_country</code> as in <code><a href="../../articles/articles/1-when-to-use-rrapply.html">vignette("1-when-to-use-rrapply")</a></code>, a nested list containing the per country shares of renewable energy as a percentage in the total energy consumption in 2016.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">rrapply</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"renewable_energy_by_country"</span>)</pre></body></html></div>
<p>First, let us convert the nested list to a melted data.frame:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(
  <span class="no">renewable_energy_melt</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(<span class="no">renewable_energy_by_country</span>, <span class="kw">how</span> <span class="kw">=</span> <span class="st">"melt"</span>)
)
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.002   0.000   0.001</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">renewable_energy_melt</span>, <span class="fl">10</span>)
<span class="co">#&gt;       L1     L2                 L3             L4</span>
<span class="co">#&gt; 1  World Africa    Northern Africa        Algeria</span>
<span class="co">#&gt; 2  World Africa    Northern Africa          Egypt</span>
<span class="co">#&gt; 3  World Africa    Northern Africa          Libya</span>
<span class="co">#&gt; 4  World Africa    Northern Africa        Morocco</span>
<span class="co">#&gt; 5  World Africa    Northern Africa          Sudan</span>
<span class="co">#&gt; 6  World Africa    Northern Africa        Tunisia</span>
<span class="co">#&gt; 7  World Africa    Northern Africa Western Sahara</span>
<span class="co">#&gt; 8  World Africa Sub-Saharan Africa Eastern Africa</span>
<span class="co">#&gt; 9  World Africa Sub-Saharan Africa Eastern Africa</span>
<span class="co">#&gt; 10 World Africa Sub-Saharan Africa Eastern Africa</span>
<span class="co">#&gt;                                L5 value</span>
<span class="co">#&gt; 1                            &lt;NA&gt;  0.08</span>
<span class="co">#&gt; 2                            &lt;NA&gt;  5.69</span>
<span class="co">#&gt; 3                            &lt;NA&gt;  1.64</span>
<span class="co">#&gt; 4                            &lt;NA&gt; 11.02</span>
<span class="co">#&gt; 5                            &lt;NA&gt; 61.64</span>
<span class="co">#&gt; 6                            &lt;NA&gt; 12.47</span>
<span class="co">#&gt; 7                            &lt;NA&gt;    NA</span>
<span class="co">#&gt; 8  British Indian Ocean Territory    NA</span>
<span class="co">#&gt; 9                         Burundi 89.22</span>
<span class="co">#&gt; 10                        Comoros 41.92</span></pre></body></html></div>
<p>As data processing and reshaping for data.frames is familiar R territory, any subsequent processing tasks are likely more straightforward to execute using the melted data.frame than using the original nested list. For instance, we can easily filter all Western European countries with <code><a href="https://Rdatatable.gitlab.io/data.table/reference/subset.data.table.html">subset()</a></code> (or using e.g. a <code>dplyr</code> or <code>data.table</code>):</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">renewable_energy_melt_west_eu</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="no">renewable_energy_melt</span>, <span class="no">L3</span> <span class="kw">==</span> <span class="st">"Western Europe"</span>)

<span class="no">renewable_energy_melt_west_eu</span>
<span class="co">#&gt;        L1     L2             L3            L4   L5 value</span>
<span class="co">#&gt; 212 World Europe Western Europe       Austria &lt;NA&gt; 34.67</span>
<span class="co">#&gt; 213 World Europe Western Europe       Belgium &lt;NA&gt;  9.14</span>
<span class="co">#&gt; 214 World Europe Western Europe        France &lt;NA&gt; 14.74</span>
<span class="co">#&gt; 215 World Europe Western Europe       Germany &lt;NA&gt; 14.17</span>
<span class="co">#&gt; 216 World Europe Western Europe Liechtenstein &lt;NA&gt; 62.93</span>
<span class="co">#&gt; 217 World Europe Western Europe    Luxembourg &lt;NA&gt; 13.54</span>
<span class="co">#&gt; 218 World Europe Western Europe        Monaco &lt;NA&gt;    NA</span>
<span class="co">#&gt; 219 World Europe Western Europe   Netherlands &lt;NA&gt;  5.78</span>
<span class="co">#&gt; 220 World Europe Western Europe   Switzerland &lt;NA&gt; 25.49</span></pre></body></html></div>
<p>For completeness, note that a similar result can also be obtained directly with <code><a href="../../reference/rrapply.html">rrapply()</a></code> using the <code>.xparents</code> argument:</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(
  <span class="no">renewable_energy_by_country</span>,
  <span class="kw">condition</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">x</span>, <span class="no">.xparents</span>) <span class="st">"Western Europe"</span> <span class="kw">%in%</span> <span class="no">.xparents</span>,
  <span class="kw">how</span> <span class="kw">=</span> <span class="st">"melt"</span>
)
<span class="co">#&gt;      L1     L2             L3            L4 value</span>
<span class="co">#&gt; 1 World Europe Western Europe       Austria 34.67</span>
<span class="co">#&gt; 2 World Europe Western Europe       Belgium  9.14</span>
<span class="co">#&gt; 3 World Europe Western Europe        France 14.74</span>
<span class="co">#&gt; 4 World Europe Western Europe       Germany 14.17</span>
<span class="co">#&gt; 5 World Europe Western Europe Liechtenstein 62.93</span>
<span class="co">#&gt; 6 World Europe Western Europe    Luxembourg 13.54</span>
<span class="co">#&gt; 7 World Europe Western Europe        Monaco    NA</span>
<span class="co">#&gt; 8 World Europe Western Europe   Netherlands  5.78</span>
<span class="co">#&gt; 9 World Europe Western Europe   Switzerland 25.49</span></pre></body></html></div>
<p>Here, the <code>L5</code> column is no longer present as the pruned list does not contain any elements at this depth before melting to a long data.frame.</p>
<p>Now let us return the same results with <code><a href="https://rdrr.io/pkg/reshape2/man/melt.html">reshape2::melt()</a></code>,</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(
  <span class="no">renewable_energy_melt_reshape2</span> <span class="kw">&lt;-</span> <span class="kw pkg">reshape2</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span>(<span class="no">renewable_energy_by_country</span>)
)
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.129   0.013   0.141</span></pre></body></html></div>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">renewable_energy_melt_reshape2</span>, <span class="fl">10</span>)
<span class="co">#&gt;    value             L4                             L5                 L3</span>
<span class="co">#&gt; 1   0.08        Algeria                           &lt;NA&gt;    Northern Africa</span>
<span class="co">#&gt; 2   5.69          Egypt                           &lt;NA&gt;    Northern Africa</span>
<span class="co">#&gt; 3   1.64          Libya                           &lt;NA&gt;    Northern Africa</span>
<span class="co">#&gt; 4  11.02        Morocco                           &lt;NA&gt;    Northern Africa</span>
<span class="co">#&gt; 5  61.64          Sudan                           &lt;NA&gt;    Northern Africa</span>
<span class="co">#&gt; 6  12.47        Tunisia                           &lt;NA&gt;    Northern Africa</span>
<span class="co">#&gt; 7     NA Western Sahara                           &lt;NA&gt;    Northern Africa</span>
<span class="co">#&gt; 8     NA Eastern Africa British Indian Ocean Territory Sub-Saharan Africa</span>
<span class="co">#&gt; 9  89.22 Eastern Africa                        Burundi Sub-Saharan Africa</span>
<span class="co">#&gt; 10 41.92 Eastern Africa                        Comoros Sub-Saharan Africa</span>
<span class="co">#&gt;        L2    L1</span>
<span class="co">#&gt; 1  Africa World</span>
<span class="co">#&gt; 2  Africa World</span>
<span class="co">#&gt; 3  Africa World</span>
<span class="co">#&gt; 4  Africa World</span>
<span class="co">#&gt; 5  Africa World</span>
<span class="co">#&gt; 6  Africa World</span>
<span class="co">#&gt; 7  Africa World</span>
<span class="co">#&gt; 8  Africa World</span>
<span class="co">#&gt; 9  Africa World</span>
<span class="co">#&gt; 10 Africa World</span></pre></body></html></div>
<p><code><a href="../../reference/rrapply.html">rrapply()</a></code> orders the columns differently by default and the <code>"value"</code> column might follow slightly different coercion rules, but other than that the data contained in the melted data.frame is identical. For a medium-sized list as used here, the computational speed of <code><a href="https://rdrr.io/pkg/reshape2/man/melt.html">reshape2::melt()</a></code> is acceptable for practical usage. However, its computational efficiency quickly decreases when melting larger or more deeply nested lists:</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="co">## helper function to generate named nested list</span>
<span class="no">new_list</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">n</span>, <span class="no">dmax</span>, <span class="no">d</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="no">name</span> <span class="kw">=</span> <span class="kw">NULL</span>) {
  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span>(<span class="kw">mode</span> <span class="kw">=</span> <span class="st">"list"</span>, <span class="kw">length</span> <span class="kw">=</span> <span class="no">n</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">x</span>) <span class="kw">&lt;-</span> <span class="kw">if</span>(!<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="no">name</span>)) <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="no">name</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="no">n</span>), <span class="kw">sep</span> <span class="kw">=</span> <span class="st">"."</span>) <span class="kw">else</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="no">n</span>)
  <span class="kw">for</span>(<span class="no">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="no">n</span>)) {
    <span class="kw">if</span>(<span class="no">d</span> + <span class="fl">1</span> <span class="kw">&lt;</span> <span class="no">dmax</span>) {
      <span class="no">x</span><span class="kw">[[</span><span class="no">i</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Recall.html">Recall</a></span>(<span class="no">n</span>, <span class="no">dmax</span>, <span class="no">d</span> + <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">name</span>, <span class="no">i</span>), <span class="kw">collapse</span> <span class="kw">=</span> <span class="st">"."</span>))
    } <span class="kw">else</span> {
      <span class="no">x</span><span class="kw">[[</span><span class="no">i</span>]] <span class="kw">&lt;-</span> <span class="fl">1L</span>
    }
  }
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">x</span>)
}

<span class="co">## generate a large shallow list with 3 layers and a total of 10^6 elements</span>
<span class="no">shallow_list</span> <span class="kw">&lt;-</span> <span class="fu">new_list</span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fl">100</span>, <span class="kw">dmax</span> <span class="kw">=</span> <span class="fl">3</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">shallow_list</span>, <span class="kw">list.len</span> <span class="kw">=</span> <span class="fl">2</span>)
<span class="co">#&gt; List of 100</span>
<span class="co">#&gt;  $ 1  :List of 100</span>
<span class="co">#&gt;   ..$ 1.1  :List of 100</span>
<span class="co">#&gt;   .. ..$ 1.1.1  : int 1</span>
<span class="co">#&gt;   .. ..$ 1.1.2  : int 1</span>
<span class="co">#&gt;   .. .. [list output truncated]</span>
<span class="co">#&gt;   ..$ 1.2  :List of 100</span>
<span class="co">#&gt;   .. ..$ 1.2.1  : int 1</span>
<span class="co">#&gt;   .. ..$ 1.2.2  : int 1</span>
<span class="co">#&gt;   .. .. [list output truncated]</span>
<span class="co">#&gt;   .. [list output truncated]</span>
<span class="co">#&gt;  $ 2  :List of 100</span>
<span class="co">#&gt;   ..$ 2.1  :List of 100</span>
<span class="co">#&gt;   .. ..$ 2.1.1  : int 1</span>
<span class="co">#&gt;   .. ..$ 2.1.2  : int 1</span>
<span class="co">#&gt;   .. .. [list output truncated]</span>
<span class="co">#&gt;   ..$ 2.2  :List of 100</span>
<span class="co">#&gt;   .. ..$ 2.2.1  : int 1</span>
<span class="co">#&gt;   .. ..$ 2.2.2  : int 1</span>
<span class="co">#&gt;   .. .. [list output truncated]</span>
<span class="co">#&gt;   .. [list output truncated]</span>
<span class="co">#&gt;   [list output truncated]</span>

<span class="co">## benchmark timing with rrapply</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(<span class="no">shallow_melt</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(<span class="no">shallow_list</span>, <span class="kw">how</span> <span class="kw">=</span> <span class="st">"melt"</span>))
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.972   0.036   1.008</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">shallow_melt</span>)
<span class="co">#&gt;   L1  L2    L3 value</span>
<span class="co">#&gt; 1  1 1.1 1.1.1     1</span>
<span class="co">#&gt; 2  1 1.1 1.1.2     1</span>
<span class="co">#&gt; 3  1 1.1 1.1.3     1</span>
<span class="co">#&gt; 4  1 1.1 1.1.4     1</span>
<span class="co">#&gt; 5  1 1.1 1.1.5     1</span>
<span class="co">#&gt; 6  1 1.1 1.1.6     1</span>

<span class="co">## benchmark timing with reshape2::melt</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(<span class="no">shallow_melt_reshape2</span> <span class="kw">&lt;-</span> <span class="kw pkg">reshape2</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span>(<span class="no">shallow_list</span>))
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt; 172.717   0.056 172.830</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">shallow_melt_reshape2</span>)
<span class="co">#&gt;   value    L3  L2 L1</span>
<span class="co">#&gt; 1     1 1.1.1 1.1  1</span>
<span class="co">#&gt; 2     1 1.1.2 1.1  1</span>
<span class="co">#&gt; 3     1 1.1.3 1.1  1</span>
<span class="co">#&gt; 4     1 1.1.4 1.1  1</span>
<span class="co">#&gt; 5     1 1.1.5 1.1  1</span>
<span class="co">#&gt; 6     1 1.1.6 1.1  1</span></pre></body></html></div>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="co">## generate a deeply nested list with 18 layers and a total of 2^18 elements</span>
<span class="no">deep_list</span> <span class="kw">&lt;-</span> <span class="fu">new_list</span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">dmax</span> <span class="kw">=</span> <span class="fl">18</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">deep_list</span>, <span class="kw">max.level</span> <span class="kw">=</span> <span class="fl">3</span>)
<span class="co">#&gt; List of 2</span>
<span class="co">#&gt;  $ 1:List of 2</span>
<span class="co">#&gt;   ..$ 1.1:List of 2</span>
<span class="co">#&gt;   .. ..$ 1.1.1:List of 2</span>
<span class="co">#&gt;   .. ..$ 1.1.2:List of 2</span>
<span class="co">#&gt;   ..$ 1.2:List of 2</span>
<span class="co">#&gt;   .. ..$ 1.2.1:List of 2</span>
<span class="co">#&gt;   .. ..$ 1.2.2:List of 2</span>
<span class="co">#&gt;  $ 2:List of 2</span>
<span class="co">#&gt;   ..$ 2.1:List of 2</span>
<span class="co">#&gt;   .. ..$ 2.1.1:List of 2</span>
<span class="co">#&gt;   .. ..$ 2.1.2:List of 2</span>
<span class="co">#&gt;   ..$ 2.2:List of 2</span>
<span class="co">#&gt;   .. ..$ 2.2.1:List of 2</span>
<span class="co">#&gt;   .. ..$ 2.2.2:List of 2</span>

<span class="co">## benchmark timing with rrapply</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(<span class="no">deep_melt</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(<span class="no">deep_list</span>, <span class="kw">how</span> <span class="kw">=</span> <span class="st">"melt"</span>))
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.369   0.040   0.409</span>

<span class="co">## benchmark timing with reshape2::melt</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(<span class="no">deep_melt_reshape2</span> <span class="kw">&lt;-</span> <span class="kw pkg">reshape2</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span>(<span class="no">deep_list</span>))
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt; 136.754   0.092 136.870</span></pre></body></html></div>
<p>Although unlikely to encounter such large or deeply nested lists in practice, these artificial examples serve to illustrate that <code><a href="https://rdrr.io/pkg/reshape2/man/melt.html">reshape2::melt()</a></code> is not very well-suited to convert large nested lists to melted data.frames.</p>
</div>
<div id="unnest-to-wide-data-frame-with-how-bind" class="section level2">
<h2 class="hasAnchor">
<a href="#unnest-to-wide-data-frame-with-how-bind" class="anchor"></a>Unnest to wide data.frame with <code>how = "bind"</code>
</h2>
<p>The option <code>how = "bind"</code> unnests a nested list to a <em>wide</em> data.frame and is only useful to unnest nested lists containing <em>repeated</em> observations of the same variables. Consider for instance the <code>pokedex</code> dataset as in <code><a href="../../articles/articles/1-when-to-use-rrapply.html">vignette("1-when-to-use-rrapply")</a></code>, a nested list containing up to 17 property variables for each of the 151 original Pokémon.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"pokedex"</span>)

<span class="co">## all 151 Pokemon entries</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">pokedex</span>, <span class="kw">list.len</span> <span class="kw">=</span> <span class="fl">3</span>)
<span class="co">#&gt; List of 1</span>
<span class="co">#&gt;  $ pokemon:List of 151</span>
<span class="co">#&gt;   ..$ :List of 16</span>
<span class="co">#&gt;   .. ..$ id            : int 1</span>
<span class="co">#&gt;   .. ..$ num           : chr "001"</span>
<span class="co">#&gt;   .. ..$ name          : chr "Bulbasaur"</span>
<span class="co">#&gt;   .. .. [list output truncated]</span>
<span class="co">#&gt;   ..$ :List of 17</span>
<span class="co">#&gt;   .. ..$ id            : int 2</span>
<span class="co">#&gt;   .. ..$ num           : chr "002"</span>
<span class="co">#&gt;   .. ..$ name          : chr "Ivysaur"</span>
<span class="co">#&gt;   .. .. [list output truncated]</span>
<span class="co">#&gt;   ..$ :List of 15</span>
<span class="co">#&gt;   .. ..$ id            : int 3</span>
<span class="co">#&gt;   .. ..$ num           : chr "003"</span>
<span class="co">#&gt;   .. ..$ name          : chr "Venusaur"</span>
<span class="co">#&gt;   .. .. [list output truncated]</span>
<span class="co">#&gt;   .. [list output truncated]</span>

<span class="co">## single Pokemon entry</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">pokedex</span><span class="kw">[[</span><span class="st">"pokemon"</span>]]<span class="kw">[[</span><span class="fl">1</span>]])
<span class="co">#&gt; List of 16</span>
<span class="co">#&gt;  $ id            : int 1</span>
<span class="co">#&gt;  $ num           : chr "001"</span>
<span class="co">#&gt;  $ name          : chr "Bulbasaur"</span>
<span class="co">#&gt;  $ img           : chr "http://www.serebii.net/pokemongo/pokemon/001.png"</span>
<span class="co">#&gt;  $ type          : chr [1:2] "Grass" "Poison"</span>
<span class="co">#&gt;  $ height        : chr "0.71 m"</span>
<span class="co">#&gt;  $ weight        : chr "6.9 kg"</span>
<span class="co">#&gt;  $ candy         : chr "Bulbasaur Candy"</span>
<span class="co">#&gt;  $ candy_count   : int 25</span>
<span class="co">#&gt;  $ egg           : chr "2 km"</span>
<span class="co">#&gt;  $ spawn_chance  : num 0.69</span>
<span class="co">#&gt;  $ avg_spawns    : int 69</span>
<span class="co">#&gt;  $ spawn_time    : chr "20:00"</span>
<span class="co">#&gt;  $ multipliers   : num 1.58</span>
<span class="co">#&gt;  $ weaknesses    : chr [1:4] "Fire" "Ice" "Flying" "Psychic"</span>
<span class="co">#&gt;  $ next_evolution:List of 2</span>
<span class="co">#&gt;   ..$ :List of 2</span>
<span class="co">#&gt;   .. ..$ num : chr "002"</span>
<span class="co">#&gt;   .. ..$ name: chr "Ivysaur"</span>
<span class="co">#&gt;   ..$ :List of 2</span>
<span class="co">#&gt;   .. ..$ num : chr "003"</span>
<span class="co">#&gt;   .. ..$ name: chr "Venusaur"</span></pre></body></html></div>
<p>Setting <code>how = "bind"</code> unnests the <code>pokedex</code> list to a wide data.frame with a single row entry for each Pokémon:</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">pokedex_wide</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(<span class="no">pokedex</span>, <span class="kw">how</span> <span class="kw">=</span> <span class="st">"bind"</span>)

<span class="co">## display few data.frame columns</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">pokedex_wide</span>[, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>:<span class="fl">3</span>, <span class="fl">5</span>:<span class="fl">10</span>)], <span class="kw">n</span> <span class="kw">=</span> <span class="fl">5</span>)
<span class="co">#&gt;   pokemon.id pokemon.num pokemon.name  pokemon.type pokemon.height</span>
<span class="co">#&gt; 1          1         001    Bulbasaur Grass, Poison         0.71 m</span>
<span class="co">#&gt; 2          2         002      Ivysaur Grass, Poison         0.99 m</span>
<span class="co">#&gt; 3          3         003     Venusaur Grass, Poison         2.01 m</span>
<span class="co">#&gt; 4          4         004   Charmander          Fire         0.61 m</span>
<span class="co">#&gt; 5          5         005   Charmeleon          Fire         1.09 m</span>
<span class="co">#&gt;   pokemon.weight    pokemon.candy pokemon.candy_count pokemon.egg</span>
<span class="co">#&gt; 1         6.9 kg  Bulbasaur Candy                  25        2 km</span>
<span class="co">#&gt; 2        13.0 kg  Bulbasaur Candy                 100 Not in Eggs</span>
<span class="co">#&gt; 3       100.0 kg  Bulbasaur Candy                  NA Not in Eggs</span>
<span class="co">#&gt; 4         8.5 kg Charmander Candy                  25        2 km</span>
<span class="co">#&gt; 5        19.0 kg Charmander Candy                 100 Not in Eggs</span>

<span class="co">## display all data.frame columns</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">pokedex_wide</span>, <span class="kw">max.level</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">vec.len</span> <span class="kw">=</span> <span class="fl">1</span>)
<span class="co">#&gt; 'data.frame':    151 obs. of  25 variables:</span>
<span class="co">#&gt;  $ pokemon.id                   : int  1 2 ...</span>
<span class="co">#&gt;  $ pokemon.num                  : chr  "001" ...</span>
<span class="co">#&gt;  $ pokemon.name                 : chr  "Bulbasaur" ...</span>
<span class="co">#&gt;  $ pokemon.img                  : chr  "http://www.serebii.net/pokemongo/pokemon/001.png" ...</span>
<span class="co">#&gt;  $ pokemon.type                 :List of 151</span>
<span class="co">#&gt;  $ pokemon.height               : chr  "0.71 m" ...</span>
<span class="co">#&gt;  $ pokemon.weight               : chr  "6.9 kg" ...</span>
<span class="co">#&gt;  $ pokemon.candy                : chr  "Bulbasaur Candy" ...</span>
<span class="co">#&gt;  $ pokemon.candy_count          : int  25 100 ...</span>
<span class="co">#&gt;  $ pokemon.egg                  : chr  "2 km" ...</span>
<span class="co">#&gt;  $ pokemon.spawn_chance         : num  0.69 0.042 ...</span>
<span class="co">#&gt;  $ pokemon.avg_spawns           : num  69 4.2 ...</span>
<span class="co">#&gt;  $ pokemon.spawn_time           : chr  "20:00" ...</span>
<span class="co">#&gt;  $ pokemon.multipliers          :List of 151</span>
<span class="co">#&gt;  $ pokemon.weaknesses           :List of 151</span>
<span class="co">#&gt;  $ pokemon.next_evolution.1.num : chr  "002" ...</span>
<span class="co">#&gt;  $ pokemon.next_evolution.1.name: chr  "Ivysaur" ...</span>
<span class="co">#&gt;  $ pokemon.next_evolution.2.num : chr  "003" ...</span>
<span class="co">#&gt;  $ pokemon.next_evolution.2.name: chr  "Venusaur" ...</span>
<span class="co">#&gt;  $ pokemon.prev_evolution.1.num : chr  NA ...</span>
<span class="co">#&gt;  $ pokemon.prev_evolution.1.name: chr  NA ...</span>
<span class="co">#&gt;  $ pokemon.prev_evolution.2.num : chr  NA ...</span>
<span class="co">#&gt;  $ pokemon.prev_evolution.2.name: chr  NA ...</span>
<span class="co">#&gt;  $ pokemon.next_evolution.3.num : chr  NA ...</span>
<span class="co">#&gt;  $ pokemon.next_evolution.3.name: chr  NA ...</span></pre></body></html></div>
<p>Each Pokémon sublist has been flattened to a single wide row in the data.frame. The 151 rows are stacked and aligned by matching variable names, with missing variables replaced by <code>NA</code>s (similar to <code><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">data.table::rbindlist(..., fill = TRUE)</a></code>). Note that any nested variables, such as <code>next_evolution</code> and <code>prev_evolution</code>, are unnested as individual data.frame columns similar to repeated application of <code><a href="https://tidyr.tidyverse.org/reference/hoist.html">tidyr::unnest_wider()</a></code> to a data.frame with nested list-columns.</p>
<p><strong>Remark</strong>: The discovery of repeated observations (e.g. individual Pokémon) is based on a depth first search of the nested list. Conceptually, the nested list is traversed to detect any multi-element sublists without names or with the same name repeated for each list element. When such a sublist is detected, each of its elements is flattened and row-binded into a wide data.frame.</p>
<div id="comparison-to-common-alternatives" class="section level3">
<h3 class="hasAnchor">
<a href="#comparison-to-common-alternatives" class="anchor"></a>Comparison to common alternatives</h3>
<p>Several common alternatives to unnest lists containing repeated observations also eluded to in the previous section include <code><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">data.table::rbindlist()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/bind.html">dplyr::bind_rows()</a></code>, and <code>tidyr</code>’s dedicated rectangling functions <code><a href="https://tidyr.tidyverse.org/reference/hoist.html">unnest_longer()</a></code>, <code><a href="https://tidyr.tidyverse.org/reference/hoist.html">unnest_wider()</a></code> and <code><a href="https://tidyr.tidyverse.org/reference/hoist.html">hoist()</a></code>.</p>
<p>The first two functions are most useful for lists of repeated data.frames (or lists) containing no further levels of nesting (e.g. data.frames without list-columns):</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="co">## bind_rows() works fine with simple lists </span>
<span class="no">pokedex_wide_dplyr</span> <span class="kw">&lt;-</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">pokedex</span><span class="kw">[[</span><span class="st">"pokemon"</span>]], <span class="no">`[`</span>, <span class="fl">1</span>:<span class="fl">4</span>))
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">pokedex_wide_dplyr</span>)
<span class="co">#&gt; # A tibble: 6 x 4</span>
<span class="co">#&gt;      id num   name       img                                             </span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;                                           </span>
<span class="co">#&gt; 1     1 001   Bulbasaur  http://www.serebii.net/pokemongo/pokemon/001.png</span>
<span class="co">#&gt; 2     2 002   Ivysaur    http://www.serebii.net/pokemongo/pokemon/002.png</span>
<span class="co">#&gt; 3     3 003   Venusaur   http://www.serebii.net/pokemongo/pokemon/003.png</span>
<span class="co">#&gt; 4     4 004   Charmander http://www.serebii.net/pokemongo/pokemon/004.png</span>
<span class="co">#&gt; 5     5 005   Charmeleon http://www.serebii.net/pokemongo/pokemon/005.png</span>
<span class="co">#&gt; 6     6 006   Charizard  http://www.serebii.net/pokemongo/pokemon/006.png</span>

<span class="co">## but does not work well with list-columns</span>
<span class="fu"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span>(<span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">pokedex</span><span class="kw">[[</span><span class="st">"pokemon"</span>]], <span class="no">`[`</span>, <span class="fl">1</span>:<span class="fl">5</span>)), <span class="kw">error</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">err</span>) <span class="no">err</span>$<span class="no">message</span>)
<span class="co">#&gt; [1] "Internal error in `vec_assign()`: `value` should have been recycled to fit `x`."</span>

<span class="co">## rbindlist() works fine with simple lists </span>
<span class="no">pokedex_wide_dt</span> <span class="kw">&lt;-</span> <span class="kw pkg">data.table</span><span class="kw ns">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">pokedex</span><span class="kw">[[</span><span class="st">"pokemon"</span>]], <span class="no">`[`</span>, <span class="fl">1</span>:<span class="fl">4</span>))
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">pokedex_wide_dt</span>)
<span class="co">#&gt;    id num       name                                              img</span>
<span class="co">#&gt; 1:  1 001  Bulbasaur http://www.serebii.net/pokemongo/pokemon/001.png</span>
<span class="co">#&gt; 2:  2 002    Ivysaur http://www.serebii.net/pokemongo/pokemon/002.png</span>
<span class="co">#&gt; 3:  3 003   Venusaur http://www.serebii.net/pokemongo/pokemon/003.png</span>
<span class="co">#&gt; 4:  4 004 Charmander http://www.serebii.net/pokemongo/pokemon/004.png</span>
<span class="co">#&gt; 5:  5 005 Charmeleon http://www.serebii.net/pokemongo/pokemon/005.png</span>
<span class="co">#&gt; 6:  6 006  Charizard http://www.serebii.net/pokemongo/pokemon/006.png</span>

<span class="co">## but is not ideal for nested variables</span>
<span class="no">pokedex_wide_dt2</span> <span class="kw">&lt;-</span> <span class="kw pkg">data.table</span><span class="kw ns">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">pokedex</span><span class="kw">[[</span><span class="st">"pokemon"</span>]], <span class="no">`[`</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"name"</span>, <span class="st">"prev_evolution"</span>)), <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="co">#&gt; Warning in data.table::rbindlist(lapply(pokedex[["pokemon"]], `[`, c("name", :</span>
<span class="co">#&gt; Column 2 ['NA'] of item 1 is length 0. This (and 78 others like it) has been</span>
<span class="co">#&gt; filled with NA (NULL for list columns) to make each item uniform.</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">pokedex_wide_dt2</span>)
<span class="co">#&gt;          name NA prev_evolution</span>
<span class="co">#&gt; 1:  Bulbasaur NA               </span>
<span class="co">#&gt; 2:    Ivysaur NA      &lt;list[2]&gt;</span>
<span class="co">#&gt; 3:   Venusaur NA      &lt;list[2]&gt;</span>
<span class="co">#&gt; 4:   Venusaur NA      &lt;list[2]&gt;</span>
<span class="co">#&gt; 5: Charmander NA               </span>
<span class="co">#&gt; 6: Charmeleon NA      &lt;list[2]&gt;</span></pre></body></html></div>
<p>The rectangling functions in the <code>tidyr</code>-package offer a lot more flexibility. A similar result as <code><a href="../../reference/rrapply.html">rrapply(pokedex, how = "bind")</a></code> can be obtained with:</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tibble</span>)

<span class="no">pokedex_wide_tidyr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/reexports.html">as_tibble</a></span>(<span class="no">pokedex</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/hoist.html">unnest_wider</a></span>(<span class="no">pokemon</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/hoist.html">unnest_wider</a></span>(<span class="no">next_evolution</span>, <span class="kw">names_sep</span> <span class="kw">=</span> <span class="st">"."</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/hoist.html">unnest_wider</a></span>(<span class="no">prev_evolution</span>, <span class="kw">names_sep</span> <span class="kw">=</span> <span class="st">"."</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/hoist.html">unnest_wider</a></span>(<span class="no">next_evolution.1</span>, <span class="kw">names_sep</span> <span class="kw">=</span> <span class="st">"."</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/hoist.html">unnest_wider</a></span>(<span class="no">next_evolution.2</span>, <span class="kw">names_sep</span> <span class="kw">=</span> <span class="st">"."</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/hoist.html">unnest_wider</a></span>(<span class="no">next_evolution.3</span>, <span class="kw">names_sep</span> <span class="kw">=</span> <span class="st">"."</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/hoist.html">unnest_wider</a></span>(<span class="no">prev_evolution.1</span>, <span class="kw">names_sep</span> <span class="kw">=</span> <span class="st">"."</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/hoist.html">unnest_wider</a></span>(<span class="no">prev_evolution.2</span>, <span class="kw">names_sep</span> <span class="kw">=</span> <span class="st">"."</span>)

<span class="no">pokedex_wide_tidyr</span>
<span class="co">#&gt; # A tibble: 151 x 25</span>
<span class="co">#&gt;       id num   name  img   type  height weight candy candy_count egg  </span>
<span class="co">#&gt;    &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;lis&gt; &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;       &lt;int&gt; &lt;chr&gt;</span>
<span class="co">#&gt;  1     1 001   Bulb… http… &lt;chr… 0.71 m 6.9 kg Bulb…          25 2 km </span>
<span class="co">#&gt;  2     2 002   Ivys… http… &lt;chr… 0.99 m 13.0 … Bulb…         100 Not …</span>
<span class="co">#&gt;  3     3 003   Venu… http… &lt;chr… 2.01 m 100.0… Bulb…          NA Not …</span>
<span class="co">#&gt;  4     4 004   Char… http… &lt;chr… 0.61 m 8.5 kg Char…          25 2 km </span>
<span class="co">#&gt;  5     5 005   Char… http… &lt;chr… 1.09 m 19.0 … Char…         100 Not …</span>
<span class="co">#&gt;  6     6 006   Char… http… &lt;chr… 1.70 m 90.5 … Char…          NA Not …</span>
<span class="co">#&gt;  7     7 007   Squi… http… &lt;chr… 0.51 m 9.0 kg Squi…          25 2 km </span>
<span class="co">#&gt;  8     8 008   Wart… http… &lt;chr… 0.99 m 22.5 … Squi…         100 Not …</span>
<span class="co">#&gt;  9     9 009   Blas… http… &lt;chr… 1.60 m 85.5 … Squi…          NA Not …</span>
<span class="co">#&gt; 10    10 010   Cate… http… &lt;chr… 0.30 m 2.9 kg Cate…          12 2 km </span>
<span class="co">#&gt; # … with 141 more rows, and 15 more variables: spawn_chance &lt;dbl&gt;,</span>
<span class="co">#&gt; #   avg_spawns &lt;dbl&gt;, spawn_time &lt;chr&gt;, multipliers &lt;list&gt;, weaknesses &lt;list&gt;,</span>
<span class="co">#&gt; #   next_evolution.1.num &lt;chr&gt;, next_evolution.1.name &lt;chr&gt;,</span>
<span class="co">#&gt; #   next_evolution.2.num &lt;chr&gt;, next_evolution.2.name &lt;chr&gt;,</span>
<span class="co">#&gt; #   next_evolution.3.num &lt;chr&gt;, next_evolution.3.name &lt;chr&gt;,</span>
<span class="co">#&gt; #   prev_evolution.1.num &lt;chr&gt;, prev_evolution.1.name &lt;chr&gt;,</span>
<span class="co">#&gt; #   prev_evolution.2.num &lt;chr&gt;, prev_evolution.2.name &lt;chr&gt;</span></pre></body></html></div>
<p>The option <code>how = "bind"</code> in <code><a href="../../reference/rrapply.html">rrapply()</a></code> is arguably less flexible as it always expands the nested list to a data.frame that is <em>as wide as possible</em>. On the other hand, the increased flexibility and interpretability in <code>tidyr</code>’s rectangling functions come at the cost of computational efficiency, which can quickly become a bottleneck when unnesting large nested lists:</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="co">## replicate the original pokedex 1000 times</span>
<span class="no">pokedex_large</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">pokemon</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="no">c</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span>(<span class="fl">1E3</span>, <span class="no">pokedex</span><span class="kw">[[</span><span class="st">"pokemon"</span>]], <span class="kw">simplify</span> <span class="kw">=</span> <span class="fl">FALSE</span>)))

<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>({
  <span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(<span class="no">pokedex_large</span>, <span class="kw">how</span> <span class="kw">=</span> <span class="st">"bind"</span>)
})
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   1.438   0.024   1.463</span>

<span class="co">## unnest only first layer of next_evolution and prev_evolution</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>({
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/reexports.html">as_tibble</a></span>(<span class="no">pokedex_large</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/hoist.html">unnest_wider</a></span>(<span class="no">pokemon</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/hoist.html">unnest_wider</a></span>(<span class="no">next_evolution</span>, <span class="kw">names_sep</span> <span class="kw">=</span> <span class="st">"."</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/hoist.html">unnest_wider</a></span>(<span class="no">prev_evolution</span>, <span class="kw">names_sep</span> <span class="kw">=</span> <span class="st">"."</span>)
})
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt; 171.917   0.332 172.293</span></pre></body></html></div>
<p>Note that the chained calls to <code><a href="https://tidyr.tidyverse.org/reference/hoist.html">unnest_wider()</a></code> above only unnest the first layer of the list-columns <code>next_evolution</code> and <code>prev_evolution</code>, and not any of the resulting children list-columns, which would only further increase computation time.</p>
<p><strong>Remark</strong>: The following approach to simultaneously unnest the nested list and post-process the resulting data.frame columns is not particularly efficient:</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="co">## Combine Pokemon evolution names in single call</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>({
  <span class="no">pokedex_large_evolutions</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(
    <span class="no">pokedex_large</span>,
    <span class="kw">classes</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"character"</span>, <span class="st">"list"</span>),
    <span class="kw">condition</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">x</span>, <span class="no">.xparents</span>) <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span>(<span class="st">"name|evolution"</span>, <span class="no">.xparents</span>)),
    <span class="kw">f</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">x</span>) <span class="kw">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span>(<span class="no">x</span>)) <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">x</span>, <span class="no">`[[`</span>, <span class="st">"name"</span>) <span class="kw">else</span> <span class="no">x</span>,
    <span class="kw">how</span> <span class="kw">=</span> <span class="st">"bind"</span>
  )
})
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;  16.329   0.012  16.341</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">pokedex_large_evolutions</span>, <span class="kw">n</span> <span class="kw">=</span> <span class="fl">9</span>)
<span class="co">#&gt;   pokemon.name pokemon.next_evolution pokemon.prev_evolution</span>
<span class="co">#&gt; 1    Bulbasaur      Ivysaur, Venusaur                     NA</span>
<span class="co">#&gt; 2      Ivysaur               Venusaur              Bulbasaur</span>
<span class="co">#&gt; 3     Venusaur                     NA     Bulbasaur, Ivysaur</span>
<span class="co">#&gt; 4   Charmander  Charmeleon, Charizard                     NA</span>
<span class="co">#&gt; 5   Charmeleon              Charizard             Charmander</span>
<span class="co">#&gt; 6    Charizard                     NA Charmander, Charmeleon</span>
<span class="co">#&gt; 7     Squirtle   Wartortle, Blastoise                     NA</span>
<span class="co">#&gt; 8    Wartortle              Blastoise               Squirtle</span>
<span class="co">#&gt; 9    Blastoise                     NA    Squirtle, Wartortle</span></pre></body></html></div>
<p>The reason is that the <code>condition</code> and <code>f</code> functions have to be applied to each node in the nested list individually and cannot be vectorized in any way, which makes this call very time-consuming. It is likely more efficient to post-process the data.frame outside the call to <code><a href="../../reference/rrapply.html">rrapply()</a></code>, e.g. using <code>data.table</code>:</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">data.table</span>, <span class="kw">quietly</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="co">## Combine Pokemon evolution names in multiple calls</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>({
  <span class="no">pokedex_large_evolutions2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span>(<span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(<span class="no">pokedex_large</span>, <span class="kw">how</span> <span class="kw">=</span> <span class="st">"bind"</span>))
  <span class="no">pokedex_large_evolutions2</span>[, <span class="no">pokemon.next_evolution</span> <span class="kw">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span>(<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/transpose.html">transpose</a></span>(<span class="no">.SD</span>)), <span class="kw">.SDcols</span> <span class="kw">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/patterns.html">patterns</a></span>(<span class="st">"next_evolution.*name"</span>)]
  <span class="no">pokedex_large_evolutions2</span>[, <span class="no">pokemon.prev_evolution</span> <span class="kw">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span>(<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/transpose.html">transpose</a></span>(<span class="no">.SD</span>)), <span class="kw">.SDcols</span> <span class="kw">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/patterns.html">patterns</a></span>(<span class="st">"prev_evolution.*name"</span>)]
})
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   3.701   0.000   3.700</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">pokedex_large_evolutions2</span>[, <span class="fu">.</span>(<span class="no">pokemon.name</span>, <span class="no">pokemon.next_evolution</span>, <span class="no">pokemon.prev_evolution</span>)])
<span class="co">#&gt;    pokemon.name  pokemon.next_evolution pokemon.prev_evolution</span>
<span class="co">#&gt; 1:    Bulbasaur     Ivysaur,Venusaur,NA                  NA,NA</span>
<span class="co">#&gt; 2:      Ivysaur          Venusaur,NA,NA           Bulbasaur,NA</span>
<span class="co">#&gt; 3:     Venusaur                NA,NA,NA      Bulbasaur,Ivysaur</span>
<span class="co">#&gt; 4:   Charmander Charmeleon,Charizard,NA                  NA,NA</span>
<span class="co">#&gt; 5:   Charmeleon         Charizard,NA,NA          Charmander,NA</span>
<span class="co">#&gt; 6:    Charizard                NA,NA,NA  Charmander,Charmeleon</span></pre></body></html></div>
</div>
<div id="additional-examples" class="section level3">
<h3 class="hasAnchor">
<a href="#additional-examples" class="anchor"></a>Additional examples</h3>
<p>We conclude this section by replicating some of the demonstrating examples in the <code>tidyr</code> vignette <a href="https://tidyr.tidyverse.org/articles/rectangle.html" class="uri">https://tidyr.tidyverse.org/articles/rectangle.html</a>. The nested list datasets are publicly available in the <a href="https://CRAN.R-project.org/package=repurrrsive">repurrrsive</a>-package.</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">repurrrsive</span>)

<span class="co">## github users dataset</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">gh_users</span>, <span class="kw">list.len</span> <span class="kw">=</span> <span class="fl">3</span>)
<span class="co">#&gt; List of 6</span>
<span class="co">#&gt;  $ :List of 30</span>
<span class="co">#&gt;   ..$ login              : chr "gaborcsardi"</span>
<span class="co">#&gt;   ..$ id                 : int 660288</span>
<span class="co">#&gt;   ..$ avatar_url         : chr "https://avatars.githubusercontent.com/u/660288?v=3"</span>
<span class="co">#&gt;   .. [list output truncated]</span>
<span class="co">#&gt;  $ :List of 30</span>
<span class="co">#&gt;   ..$ login              : chr "jennybc"</span>
<span class="co">#&gt;   ..$ id                 : int 599454</span>
<span class="co">#&gt;   ..$ avatar_url         : chr "https://avatars.githubusercontent.com/u/599454?v=3"</span>
<span class="co">#&gt;   .. [list output truncated]</span>
<span class="co">#&gt;  $ :List of 30</span>
<span class="co">#&gt;   ..$ login              : chr "jtleek"</span>
<span class="co">#&gt;   ..$ id                 : int 1571674</span>
<span class="co">#&gt;   ..$ avatar_url         : chr "https://avatars.githubusercontent.com/u/1571674?v=3"</span>
<span class="co">#&gt;   .. [list output truncated]</span>
<span class="co">#&gt;   [list output truncated]</span>

<span class="co">## return all variables in result</span>
<span class="no">gh_users_wide</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(<span class="no">gh_users</span>, <span class="kw">how</span> <span class="kw">=</span> <span class="st">"bind"</span>)

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">gh_users_wide</span>[, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"login"</span>, <span class="st">"followers"</span>, <span class="st">"url"</span>, <span class="st">"html_url"</span>)])
<span class="co">#&gt;         login followers                                      url</span>
<span class="co">#&gt; 1 gaborcsardi       303 https://api.github.com/users/gaborcsardi</span>
<span class="co">#&gt; 2     jennybc       780     https://api.github.com/users/jennybc</span>
<span class="co">#&gt; 3      jtleek      3958      https://api.github.com/users/jtleek</span>
<span class="co">#&gt; 4  juliasilge       115  https://api.github.com/users/juliasilge</span>
<span class="co">#&gt; 5      leeper       213      https://api.github.com/users/leeper</span>
<span class="co">#&gt; 6    masalmon        34    https://api.github.com/users/masalmon</span>
<span class="co">#&gt;                         html_url</span>
<span class="co">#&gt; 1 https://github.com/gaborcsardi</span>
<span class="co">#&gt; 2     https://github.com/jennybc</span>
<span class="co">#&gt; 3      https://github.com/jtleek</span>
<span class="co">#&gt; 4  https://github.com/juliasilge</span>
<span class="co">#&gt; 5      https://github.com/leeper</span>
<span class="co">#&gt; 6    https://github.com/masalmon</span>

<span class="co">## github repos dataset</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">gh_repos</span>, <span class="kw">list.len</span> <span class="kw">=</span> <span class="fl">2</span>)
<span class="co">#&gt; List of 6</span>
<span class="co">#&gt;  $ :List of 30</span>
<span class="co">#&gt;   ..$ :List of 68</span>
<span class="co">#&gt;   .. ..$ id               : int 61160198</span>
<span class="co">#&gt;   .. ..$ name             : chr "after"</span>
<span class="co">#&gt;   .. .. [list output truncated]</span>
<span class="co">#&gt;   ..$ :List of 68</span>
<span class="co">#&gt;   .. ..$ id               : int 40500181</span>
<span class="co">#&gt;   .. ..$ name             : chr "argufy"</span>
<span class="co">#&gt;   .. .. [list output truncated]</span>
<span class="co">#&gt;   .. [list output truncated]</span>
<span class="co">#&gt;  $ :List of 30</span>
<span class="co">#&gt;   ..$ :List of 68</span>
<span class="co">#&gt;   .. ..$ id               : int 14756210</span>
<span class="co">#&gt;   .. ..$ name             : chr "2013-11_sfu"</span>
<span class="co">#&gt;   .. .. [list output truncated]</span>
<span class="co">#&gt;   ..$ :List of 68</span>
<span class="co">#&gt;   .. ..$ id               : int 14152301</span>
<span class="co">#&gt;   .. ..$ name             : chr "2014-01-27-miami"</span>
<span class="co">#&gt;   .. .. [list output truncated]</span>
<span class="co">#&gt;   .. [list output truncated]</span>
<span class="co">#&gt;   [list output truncated]</span>

<span class="co">## return only a subset of variables</span>
<span class="no">gh_repos_wide</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="no">gh_repos</span>, <span class="kw">recursive</span> <span class="kw">=</span> <span class="fl">FALSE</span>),
  <span class="kw">condition</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">x</span>, <span class="no">.xname</span>) <span class="no">.xname</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"login"</span>, <span class="st">"name"</span>, <span class="st">"homepage"</span>, <span class="st">"watchers_count"</span>),
  <span class="kw">how</span> <span class="kw">=</span> <span class="st">"bind"</span>
)

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">gh_repos_wide</span>)
<span class="co">#&gt;          name owner.login homepage watchers_count</span>
<span class="co">#&gt; 1       after gaborcsardi     NULL              5</span>
<span class="co">#&gt; 2      argufy gaborcsardi     NULL             19</span>
<span class="co">#&gt; 3         ask gaborcsardi     NULL              5</span>
<span class="co">#&gt; 4 baseimports gaborcsardi     NULL              0</span>
<span class="co">#&gt; 5      citest gaborcsardi     NULL              0</span>
<span class="co">#&gt; 6  clisymbols gaborcsardi                      18</span>

<span class="co">## GoT characters dataset</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">got_chars</span>, <span class="kw">list.len</span> <span class="kw">=</span> <span class="fl">3</span>)
<span class="co">#&gt; List of 30</span>
<span class="co">#&gt;  $ :List of 18</span>
<span class="co">#&gt;   ..$ url        : chr "https://www.anapioficeandfire.com/api/characters/1022"</span>
<span class="co">#&gt;   ..$ id         : int 1022</span>
<span class="co">#&gt;   ..$ name       : chr "Theon Greyjoy"</span>
<span class="co">#&gt;   .. [list output truncated]</span>
<span class="co">#&gt;  $ :List of 18</span>
<span class="co">#&gt;   ..$ url        : chr "https://www.anapioficeandfire.com/api/characters/1052"</span>
<span class="co">#&gt;   ..$ id         : int 1052</span>
<span class="co">#&gt;   ..$ name       : chr "Tyrion Lannister"</span>
<span class="co">#&gt;   .. [list output truncated]</span>
<span class="co">#&gt;  $ :List of 18</span>
<span class="co">#&gt;   ..$ url        : chr "https://www.anapioficeandfire.com/api/characters/1074"</span>
<span class="co">#&gt;   ..$ id         : int 1074</span>
<span class="co">#&gt;   ..$ name       : chr "Victarion Greyjoy"</span>
<span class="co">#&gt;   .. [list output truncated]</span>
<span class="co">#&gt;   [list output truncated]</span>

<span class="co">## return only list-columns</span>
<span class="no">got_chars_wide</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(<span class="no">got_chars</span>, <span class="kw">how</span> <span class="kw">=</span> <span class="st">"bind"</span>)
<span class="no">got_chars_wide</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(<span class="no">got_chars_wide</span>, <span class="kw">classes</span> <span class="kw">=</span> <span class="st">"list"</span>, <span class="kw">how</span> <span class="kw">=</span> <span class="st">"prune"</span>)

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="fu"><a href="https://tidyr.tidyverse.org/reference/reexports.html">as_tibble</a></span>(<span class="no">got_chars_wide</span>))
<span class="co">#&gt; # A tibble: 6 x 7</span>
<span class="co">#&gt;   titles    aliases    allegiances books     povBooks  tvSeries  playedBy </span>
<span class="co">#&gt;   &lt;list&gt;    &lt;list&gt;     &lt;list&gt;      &lt;list&gt;    &lt;list&gt;    &lt;list&gt;    &lt;list&gt;   </span>
<span class="co">#&gt; 1 &lt;chr [3]&gt; &lt;chr [4]&gt;  &lt;chr [1]&gt;   &lt;chr [3]&gt; &lt;chr [2]&gt; &lt;chr [6]&gt; &lt;chr [1]&gt;</span>
<span class="co">#&gt; 2 &lt;chr [2]&gt; &lt;chr [11]&gt; &lt;chr [1]&gt;   &lt;chr [2]&gt; &lt;chr [4]&gt; &lt;chr [6]&gt; &lt;chr [1]&gt;</span>
<span class="co">#&gt; 3 &lt;chr [2]&gt; &lt;chr [1]&gt;  &lt;chr [1]&gt;   &lt;chr [3]&gt; &lt;chr [2]&gt; &lt;chr [1]&gt; &lt;chr [1]&gt;</span>
<span class="co">#&gt; 4 &lt;chr [1]&gt; &lt;chr [1]&gt;  &lt;lgl [1]&gt;   &lt;chr [1]&gt; &lt;chr [1]&gt; &lt;chr [1]&gt; &lt;chr [1]&gt;</span>
<span class="co">#&gt; 5 &lt;chr [1]&gt; &lt;chr [1]&gt;  &lt;chr [1]&gt;   &lt;chr [3]&gt; &lt;chr [2]&gt; &lt;chr [2]&gt; &lt;chr [1]&gt;</span>
<span class="co">#&gt; 6 &lt;chr [1]&gt; &lt;chr [1]&gt;  &lt;lgl [1]&gt;   &lt;chr [2]&gt; &lt;chr [1]&gt; &lt;chr [1]&gt; &lt;chr [1]&gt;</span></pre></body></html></div>
</div>
</div>
</div>
<div id="efficient-unmelting-of-melted-data-frames" class="section level1">
<h1 class="hasAnchor">
<a href="#efficient-unmelting-of-melted-data-frames" class="anchor"></a>Efficient unmelting of melted data.frames</h1>
<p>Let’s return to the example of the melted long data.frame in the first section containing only the renewable energy shares of Western European countries:</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="no">renewable_energy_melt_west_eu</span>
<span class="co">#&gt;        L1     L2             L3            L4   L5 value</span>
<span class="co">#&gt; 212 World Europe Western Europe       Austria &lt;NA&gt; 34.67</span>
<span class="co">#&gt; 213 World Europe Western Europe       Belgium &lt;NA&gt;  9.14</span>
<span class="co">#&gt; 214 World Europe Western Europe        France &lt;NA&gt; 14.74</span>
<span class="co">#&gt; 215 World Europe Western Europe       Germany &lt;NA&gt; 14.17</span>
<span class="co">#&gt; 216 World Europe Western Europe Liechtenstein &lt;NA&gt; 62.93</span>
<span class="co">#&gt; 217 World Europe Western Europe    Luxembourg &lt;NA&gt; 13.54</span>
<span class="co">#&gt; 218 World Europe Western Europe        Monaco &lt;NA&gt;    NA</span>
<span class="co">#&gt; 219 World Europe Western Europe   Netherlands &lt;NA&gt;  5.78</span>
<span class="co">#&gt; 220 World Europe Western Europe   Switzerland &lt;NA&gt; 25.49</span></pre></body></html></div>
<p>Suppose that this data.frame needs to be converted back to a nested list object in order to write it to a JSON- or XML-object, or perhaps for some tree visualization purpose. Writing a recursive function to restore the nested list can prove to be quite a time-consuming and error-prone task. Base R’s <code><a href="https://rdrr.io/r/base/unlist.html">unlist()</a></code> function has an inverse function <code><a href="https://rdrr.io/r/utils/relist.html">relist()</a></code>, but <code><a href="https://rdrr.io/r/utils/relist.html">relist()</a></code> requires a <code>skeleton</code> nested list to repopulate, and such a <code>skeleton</code> is clearly unavailable in the current context. In particular, since we have filtered entries from the melted data.frame, we can no longer use the original list as a template object, without filtering nodes from the original list as well.</p>
<p>To this purpose, <code><a href="../../reference/rrapply.html">rrapply()</a></code> includes the additional option <code>how = "unmelt"</code> that performs the inverse operation of <code>how = "melt"</code>. No skeleton object is needed in this case, only an ordinary data.frame in the format returned by <code>how = "melt"</code>. To illustrate, we can convert the melted data.frame above to a nested list as follows:</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="no">renewable_energy_west_eu_unmelt</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(<span class="no">renewable_energy_melt_west_eu</span>, <span class="kw">how</span> <span class="kw">=</span> <span class="st">"unmelt"</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">renewable_energy_west_eu_unmelt</span>, <span class="kw">give.attr</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
<span class="co">#&gt; List of 1</span>
<span class="co">#&gt;  $ World:List of 1</span>
<span class="co">#&gt;   ..$ Europe:List of 1</span>
<span class="co">#&gt;   .. ..$ Western Europe:List of 9</span>
<span class="co">#&gt;   .. .. ..$ Austria      : num 34.7</span>
<span class="co">#&gt;   .. .. ..$ Belgium      : num 9.14</span>
<span class="co">#&gt;   .. .. ..$ France       : num 14.7</span>
<span class="co">#&gt;   .. .. ..$ Germany      : num 14.2</span>
<span class="co">#&gt;   .. .. ..$ Liechtenstein: num 62.9</span>
<span class="co">#&gt;   .. .. ..$ Luxembourg   : num 13.5</span>
<span class="co">#&gt;   .. .. ..$ Monaco       : num NA</span>
<span class="co">#&gt;   .. .. ..$ Netherlands  : num 5.78</span>
<span class="co">#&gt;   .. .. ..$ Switzerland  : num 25.5</span></pre></body></html></div>
<p><strong>Remark 1:</strong> <code>how = "unmelt"</code> is based on a <em>greedy</em> approach parsing data.frame rows as list elements starting from the top of the data.frame. That is, <code><a href="../../reference/rrapply.html">rrapply()</a></code> continues collecting children nodes as long as the parent node name remains unchanged. If, for instance, we wish to create two separate nodes (on the same level) with the name <code>"Western Europe"</code>, these nodes should not be listed after one another in the melted data.frame as <code><a href="../../reference/rrapply.html">rrapply()</a></code> will group all children under a single <code>"Western Europe"</code> list element.</p>
<p><strong>Remark 2:</strong> Internally, <code>how = "unmelt"</code> reconstructs a nested list from the melted data.frame and subsequently follows the same conceptual framework as <code>how = "replace"</code>. Any other function arguments, such as <code>f</code> and <code>condition</code> should therefore be used in exactly the same way as one would use them for <code>how = "replace"</code> applied to a nested list object.</p>
<p><strong>Remark 3:</strong> <code>how = "unmelt"</code> does (currently) not restore the attributes of intermediate list nodes and is therefore not an exact inverse of <code>how = "melt"</code>. The other way around will always produce the same results:</p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="no">renewable_energy_unmelt</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(<span class="no">renewable_energy_melt</span>, <span class="kw">how</span> <span class="kw">=</span> <span class="st">"unmelt"</span>)
<span class="no">renewable_energy_remelt</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(<span class="no">renewable_energy_unmelt</span>, <span class="kw">how</span> <span class="kw">=</span> <span class="st">"melt"</span>)

<span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span>(<span class="no">renewable_energy_melt</span>, <span class="no">renewable_energy_remelt</span>)
<span class="co">#&gt; [1] TRUE</span></pre></body></html></div>
<p>In terms of computational effort, <code><a href="../../reference/rrapply.html">rrapply()</a></code>’s <code>how = "unmelt"</code> can be equally or more efficient than base R’s <code><a href="https://rdrr.io/r/utils/relist.html">relist()</a></code> even though there is no template list object that can be repopulated. This is illustrated using the large list objects generated above:</p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="co">## deeply nested list with 18 layers and a total of 2^18 elements</span>
<span class="co">## benchmark timing with rrapply how = "unmelt"</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(<span class="no">deep_unmelt</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(<span class="no">deep_melt</span>, <span class="kw">how</span> <span class="kw">=</span> <span class="st">"unmelt"</span>))
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;    0.17    0.00    0.17</span>
<span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span>(<span class="no">deep_unmelt</span>, <span class="no">deep_list</span>)
<span class="co">#&gt; [1] TRUE</span>

<span class="co">## benchmark timing with relist</span>
<span class="no">deep_unlist</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/utils/relist.html">as.relistable</a></span>(<span class="no">deep_list</span>))
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(<span class="no">deep_relist</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/relist.html">relist</a></span>(<span class="no">deep_unlist</span>))
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;  22.382   0.000  22.382</span></pre></body></html></div>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="co">## large shallow list with 3 layers and a total of 10^6 elements</span>
<span class="co">## benchmark timing with rrapply how = "unmelt"</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(<span class="no">shallow_unmelt</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/rrapply.html">rrapply</a></span>(<span class="no">shallow_melt</span>, <span class="kw">how</span> <span class="kw">=</span> <span class="st">"unmelt"</span>))
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.133   0.000   0.133</span>
<span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span>(<span class="no">shallow_unmelt</span>, <span class="no">shallow_list</span>)
<span class="co">#&gt; [1] TRUE</span>

<span class="co">## benchmark timing with relist</span>
<span class="no">shallow_unlist</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/utils/relist.html">as.relistable</a></span>(<span class="no">shallow_list</span>))
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(<span class="no">shallow_relist</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/relist.html">relist</a></span>(<span class="no">shallow_unlist</span>))
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   6.842   0.000   6.842</span></pre></body></html></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Joris Chau.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
